<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.1//EN" "http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
    <title>21-åŸå­ç±»ï¼šæ— é”å·¥å…·ç±»çš„å…¸èŒƒ</title>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/>
        <style>
        html {
            color: #333;
            -webkit-text-size-adjust: 100%;
            -ms-text-size-adjust: 100%;
            text-rendering: optimizelegibility;
            font-family: Helvetica Neue, PingFang SC, Verdana, Microsoft Yahei, Hiragino Sans GB, Microsoft Sans Serif, WenQuanYi Micro Hei, sans-serif
        }

        html.borderbox *,
        html.borderbox :after,
        html.borderbox :before {
            box-sizing: border-box
        }

        article,
        aside,
        blockquote,
        body,
        button,
        code,
        dd,
        details,
        dl,
        dt,
        fieldset,
        figcaption,
        figure,
        footer,
        form,
        h1,
        h2,
        h3,
        h4,
        h5,
        h6,
        header,
        hr,
        input,
        legend,
        li,
        menu,
        nav,
        ol,
        p,
        pre,
        section,
        td,
        textarea,
        th,
        ul {
            margin: 0;
            padding: 0
        }

        article,
        aside,
        details,
        figcaption,
        figure,
        footer,
        header,
        menu,
        nav,
        section {
            display: block
        }

        audio,
        canvas,
        video {
            display: inline-block
        }

        body,
        button,
        input,
        select,
        textarea {
            font: 300 1em/1.8 PingFang SC, Lantinghei SC, Microsoft Yahei, Hiragino Sans GB, Microsoft Sans Serif, WenQuanYi Micro Hei, Helvetica, sans-serif
        }

        button::-moz-focus-inner,
        input::-moz-focus-inner {
            padding: 0;
            border: 0
        }

        table {
            border-collapse: collapse;
            border-spacing: 0
        }

        fieldset,
        img {
            border: 0
        }

        blockquote {
            position: relative;
            color: #999;
            font-weight: 400;
            border-left: 1px solid #1abc9c;
            padding-left: 1em;
            margin: 1em 3em 1em 2em
        }

        @media only screen and (max-width: 640px) {
            blockquote {
                margin: 1em 0
            }
        }

        abbr,
        acronym {
            border-bottom: 1px dotted;
            font-variant: normal
        }

        abbr {
            cursor: help
        }

        del {
            text-decoration: line-through
        }

        address,
        caption,
        cite,
        code,
        dfn,
        em,
        th,
        var {
            font-style: normal;
            font-weight: 400
        }

        ol,
        ul {
            list-style: none
        }

        caption,
        th {
            text-align: left
        }

        q:after,
        q:before {
            content: ""
        }

        sub,
        sup {
            font-size: 75%;
            line-height: 0;
            position: relative
        }

        :root sub,
        :root sup {
            vertical-align: baseline
        }

        sup {
            top: -.5em
        }

        sub {
            bottom: -.25em
        }

        a {
            color: #1abc9c
        }

        a:hover {
            text-decoration: underline
        }

        .typo a {
            border-bottom: 1px solid #1abc9c
        }

        .typo a:hover {
            border-bottom-color: #555;
            color: #555
        }

        .typo a:hover,
        a,
        ins {
            text-decoration: none
        }

        .typo-u,
        u {
            text-decoration: underline
        }

        mark {
            background: #fffdd1;
            border-bottom: 1px solid #ffedce;
            padding: 2px;
            margin: 0 5px
        }

        code,
        pre,
        pre tt {
            font-family: Courier, Courier New, monospace
        }

        pre {
            background: hsla(0, 0%, 97%, .7);
            border: 1px solid #ddd;
            padding: 1em 1.5em;
            display: block;
            -webkit-overflow-scrolling: touch
        }

        hr {
            border: none;
            border-bottom: 1px solid #cfcfcf;
            margin-bottom: .8em;
            height: 10px
        }

        .typo-small,
        figcaption,
        small {
            font-size: .9em;
            color: #888
        }

        b,
        strong {
            font-weight: 700;
            color: #000
        }

        [draggable] {
            cursor: move
        }

        .clearfix:after,
        .clearfix:before {
            content: "";
            display: table
        }

        .clearfix:after {
            clear: both
        }

        .clearfix {
            zoom: 1
        }

        .textwrap,
        .textwrap td,
        .textwrap th {
            word-wrap: break-word;
            word-break: break-all
        }

        .textwrap-table {
            table-layout: fixed
        }

        .serif {
            font-family: Palatino, Optima, Georgia, serif
        }

        .typo-dl,
        .typo-form,
        .typo-hr,
        .typo-ol,
        .typo-p,
        .typo-pre,
        .typo-table,
        .typo-ul,
        .typo dl,
        .typo form,
        .typo hr,
        .typo ol,
        .typo p,
        .typo pre,
        .typo table,
        .typo ul,
        blockquote {
            margin-bottom: 1rem
        }

        h1,
        h2,
        h3,
        h4,
        h5,
        h6 {
            font-family: PingFang SC, Helvetica Neue, Verdana, Microsoft Yahei, Hiragino Sans GB, Microsoft Sans Serif, WenQuanYi Micro Hei, sans-serif;
            color: #000;
            line-height: 1.35
        }

        .typo-h1,
        .typo-h2,
        .typo-h3,
        .typo-h4,
        .typo-h5,
        .typo-h6,
        .typo h1,
        .typo h2,
        .typo h3,
        .typo h4,
        .typo h5,
        .typo h6 {
            margin-top: 1.2em;
            margin-bottom: .6em;
            line-height: 1.35
        }

        .typo-h1,
        .typo h1 {
            font-size: 2em
        }

        .typo-h2,
        .typo h2 {
            font-size: 1.8em
        }

        .typo-h3,
        .typo h3 {
            font-size: 1.6em
        }

        .typo-h4,
        .typo h4 {
            font-size: 1.4em
        }

        .typo-h5,
        .typo-h6,
        .typo h5,
        .typo h6 {
            font-size: 1.2em
        }

        .typo-ul,
        .typo ul {
            margin-left: 1.3em;
            list-style: disc
        }

        .typo-ol,
        .typo ol {
            list-style: decimal;
            margin-left: 1.9em
        }

        .typo-ol ol,
        .typo-ol ul,
        .typo-ul ol,
        .typo-ul ul,
        .typo li ol,
        .typo li ul {
            margin-bottom: .8em;
            margin-left: 2em
        }

        .typo-ol ul,
        .typo-ul ul,
        .typo li ul {
            list-style: circle
        }

        .typo-table td,
        .typo-table th,
        .typo table caption,
        .typo table td,
        .typo table th {
            border: 1px solid #ddd;
            padding: .5em 1em;
            color: #666
        }

        .typo-table th,
        .typo table th {
            background: #fbfbfb
        }

        .typo-table thead th,
        .typo table thead th {
            background: hsla(0, 0%, 95%, .7)
        }

        .typo table caption {
            border-bottom: none
        }

        .typo-input,
        .typo-textarea {
            -webkit-appearance: none;
            border-radius: 0
        }

        .typo-em,
        .typo em,
        caption,
        legend {
            color: #000;
            font-weight: inherit
        }

        .typo-em {
            position: relative
        }

        .typo-em:after {
            position: absolute;
            top: .65em;
            left: 0;
            width: 100%;
            overflow: hidden;
            white-space: nowrap;
            content: "\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB"
        }

        .typo img {
            max-width: 100%
        }

        .common-content {
            font-weight: 400;
            color: #353535;
            line-height: 1.75rem;
            white-space: normal;
            word-break: normal;
            font-size: 1rem
        }

        .common-content img {
            display: block;
            max-width: 100%;
            background-color: #eee
        }

        .common-content audio,
        .common-content video {
            width: 100%;
            background-color: #eee
        }

        .common-content center,
        .common-content font {
            margin-top: 1rem;
            display: inline-block
        }

        .common-content center {
            width: 100%
        }

        .common-content pre {
            margin-top: 1rem;
            padding-left: 0;
            padding-right: 0;
            position: relative;
            overflow: hidden
        }

        .common-content pre code {
            font-size: .8rem;
            font-family: Consolas, Liberation Mono, Menlo, monospace, Courier;
            display: block;
            width: 100%;
            box-sizing: border-box;
            padding-left: 1rem;
            padding-right: 1rem;
            overflow-x: auto
        }

        .common-content hr {
            border: none;
            margin-top: 1.5rem;
            margin-bottom: 1.5rem;
            border-top: 1px solid #f5f5f5;
            height: 1px;
            background: none
        }

        .common-content b,
        .common-content h1,
        .common-content h2,
        .common-content h3,
        .common-content h4,
        .common-content h5,
        .common-content strong {
            font-weight: 700
        }

        .common-content h1,
        .common-content h2 {
            font-size: 1.125rem;
            margin-bottom: .45rem
        }

        .common-content h3,
        .common-content h4,
        .common-content h5 {
            font-size: 1rem;
            margin-bottom: .45rem
        }

        .common-content p {
            font-weight: 400;
            color: #353535;
            margin-top: .15rem
        }

        .common-content .orange {
            color: #ff5a05
        }

        .common-content .reference {
            font-size: 1rem;
            color: #888
        }

        .custom-rich-content h1 {
            margin-top: 0;
            font-weight: 400;
            font-size: 15.25px;
            border-bottom: 1px solid #eee;
            line-height: 2.8
        }

        .custom-rich-content li,
        .custom-rich-content p {
            font-size: 14px;
            color: #888;
            line-height: 1.6
        }

        table.hljs-ln {
            margin-bottom: 0;
            border-spacing: 0;
            border-collapse: collapse
        }

        table.hljs-ln,
        table.hljs-ln tbody,
        table.hljs-ln td,
        table.hljs-ln tr {
            box-sizing: border-box
        }

        table.hljs-ln td {
            padding: 0;
            border: 0
        }

        table.hljs-ln td.hljs-ln-numbers {
            min-width: 15px;
            color: rgba(27, 31, 35, .3);
            text-align: right;
            white-space: nowrap;
            cursor: pointer;
            user-select: none
        }

        table.hljs-ln td.hljs-ln-code,
        table.hljs-ln td.hljs-ln-numbers {
            font-family: SFMono-Regular, Consolas, Liberation Mono, Menlo, Courier, monospace;
            font-size: 12px;
            line-height: 20px;
            vertical-align: top
        }

        table.hljs-ln td.hljs-ln-code {
            position: relative;
            padding-right: 10px;
            padding-left: 10px;
            overflow: visible;
            color: #24292e;
            word-wrap: normal;
            white-space: pre
        }

        video::-webkit-media-controls {
            overflow: hidden !important
        }

        video::-webkit-media-controls-enclosure {
            width: calc(100% + 32px);
            margin-left: auto
        }

        ._29HP61GA_0 {
            max-width:800px;
            margin:0 auto;
            margin-bottom: 20px;
            font-weight: 400;
            color: #353535;
            line-height: 1.76;
            white-space: normal;
            word-break: normal;
            font-size: 17px;
            -webkit-transition: background-color .3s ease;
            transition: background-color .3s ease
        }

        ._29HP61GA_0 .MathJax_Display {
            overflow: auto
        }

        ._29HP61GA_0 .poster {
            position: fixed;
            left: -10000px;
            top: -10000px;
            overflow: hidden;
            padding: 1rem;
            background: #ececec
        }

        ._29HP61GA_0 .richcontent-pre-copy {
            font-size: 13px;
            color: #888;
            position: absolute;
            right: 1em;
            top: .5em;
            cursor: pointer;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none
        }

        ._29HP61GA_0 .richcontent-pre-copy .iconfont {
            font-size: 12px;
            margin-right: .2em
        }

        ._29HP61GA_0 a {
            color: #fa8919;
            border-bottom: 1px solid #fa8919
        }

        ._29HP61GA_0 img {
            display: block;
            max-width: 100%;
            position: relative;
            left: 50%;
            -webkit-transform: translateX(-50%);
            transform: translateX(-50%);
            background-color: #eee;
            vertical-align: top;
            border-radius: 0
        }

        ._29HP61GA_0 audio,
        ._29HP61GA_0 video {
            width: 100%;
            background-color: #eee
        }

        ._29HP61GA_0 pre {
            margin-top: 16px;
            padding: 34px 0 0;
            margin-bottom: 30px;
            position: relative;
            border-radius: 6px;
            background: rgba(246, 247, 251, .749);
            border: 0
        }

        ._29HP61GA_0 pre code {
            font-size: 12px;
            font-family: Consolas, Liberation Mono, Menlo, monospace, Courier;
            display: block;
            -webkit-box-sizing: border-box;
            box-sizing: border-box;
            margin-left: 16px;
            margin-right: 16px;
            overflow-x: scroll
        }

        ._29HP61GA_0 pre code:after {
            content: "";
            height: 30px;
            width: 100%;
            display: block
        }

        ._29HP61GA_0 hr {
            border: none;
            margin-top: 1.5rem;
            margin-bottom: 1.5rem;
            border-top: 1px solid #f5f5f5;
            height: 1px;
            background: none
        }

        ._29HP61GA_0 h1,
        ._29HP61GA_0 h2,
        ._29HP61GA_0 h3,
        ._29HP61GA_0 h4,
        ._29HP61GA_0 h5 {
            margin-bottom: 20px;
            margin-top: 0;
            font-weight: 700
        }

        ._29HP61GA_0 b,
        ._29HP61GA_0 strong {
            font-weight: 700
        }

        ._29HP61GA_0 h1 {
            font-size: 21px
        }

        ._29HP61GA_0 h2 {
            font-size: 20px
        }

        ._29HP61GA_0 h3 {
            font-size: 19px
        }

        ._29HP61GA_0 h4 {
            font-size: 18px
        }

        ._29HP61GA_0 h5 {
            font-size: 17px
        }

        ._29HP61GA_0 center,
        ._29HP61GA_0 p {
            font-weight: 400;
            color: #353535;
            margin-top: 0;
            margin-bottom: 30px;
            word-break: break-word
        }

        ._29HP61GA_0 center {
            text-align: center
        }

        ._29HP61GA_0 blockquote {
            margin-top: 0;
            margin-bottom: 34px;
            border-left: 3px solid #e8e8e8;
            padding-left: 17px;
            color: #353535
        }

        ._29HP61GA_0 blockquote p {
            margin-top: 0;
            margin-bottom: 0
        }

        ._29HP61GA_0 ol,
        ._29HP61GA_0 ul {
            margin-bottom: 30px
        }

        ._29HP61GA_0 ol p,
        ._29HP61GA_0 ul p {
            margin-top: 0;
            margin-bottom: 0
        }

        ._29HP61GA_0 ol {
            list-style: decimal;
            margin-left: 20px
        }

        ._29HP61GA_0 ul li {
            padding-left: 17px;
            position: relative;
            margin-bottom: 10px
        }

        ._29HP61GA_0 ul li:after {
            content: "";
            height: 6px;
            width: 6px;
            border-radius: 50%;
            background: #353535;
            position: absolute;
            top: 10px;
            left: 0
        }

        ._29HP61GA_0 .orange {
            color: #fa8919
        }

        ._29HP61GA_0 .reference {
            color: #888
        }

        ._29HP61GA_0 .m-right {
            text-align: right
        }

        ._29HP61GA_0 .m-center {
            text-align: center;
            display: block
        }

        ._29HP61GA_0 .m-gray {
            color: #888
        }

        ._29HP61GA_0 .m-small {
            font-size: 15px
        }

        ._29HP61GA_0 table.hljs-ln {
            margin-bottom: 0;
            border-spacing: 0;
            border-collapse: collapse
        }

        ._29HP61GA_0 table.hljs-ln,
        ._29HP61GA_0 table.hljs-ln tbody,
        ._29HP61GA_0 table.hljs-ln td,
        ._29HP61GA_0 table.hljs-ln tr {
            -webkit-box-sizing: border-box;
            box-sizing: border-box
        }

        ._29HP61GA_0 table.hljs-ln td {
            padding: 0;
            border: 0
        }

        ._29HP61GA_0 table.hljs-ln td.hljs-ln-numbers {
            min-width: 15px;
            font-size: 12px;
            color: rgba(27, 31, 35, .3);
            text-align: right;
            white-space: nowrap;
            cursor: pointer;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none
        }

        ._29HP61GA_0 table.hljs-ln td.hljs-ln-code,
        ._29HP61GA_0 table.hljs-ln td.hljs-ln-numbers {
            font-family: SFMono-Regular, Consolas, Liberation Mono, Menlo, Courier, monospace;
            line-height: 20px;
            vertical-align: top
        }

        ._29HP61GA_0 table.hljs-ln td.hljs-ln-code {
            position: relative;
            padding-right: 10px;
            padding-left: 10px;
            overflow: visible;
            font-size: 13px;
            color: #666;
            word-wrap: normal;
            white-space: pre
        }

    </style>
</head>
<body>
<div class="_29HP61GA_0">
<h1>21-åŸå­ç±»ï¼šæ— é”å·¥å…·ç±»çš„å…¸èŒƒ</h1>
<p>å‰é¢æˆ‘ä»¬å¤šæ¬¡æåˆ°ä¸€ä¸ªç´¯åŠ å™¨çš„ä¾‹å­ï¼Œç¤ºä¾‹ä»£ç å¦‚ä¸‹ã€‚åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œadd10K()è¿™ä¸ªæ–¹æ³•ä¸æ˜¯çº¿ç¨‹å®‰å…¨çš„ï¼Œé—®é¢˜å°±å‡ºåœ¨å˜é‡countçš„å¯è§æ€§å’Œcount+=1çš„åŸå­æ€§ä¸Šã€‚å¯è§æ€§é—®é¢˜å¯ä»¥ç”¨volatileæ¥è§£å†³ï¼Œè€ŒåŸå­æ€§é—®é¢˜æˆ‘ä»¬å‰é¢ä¸€ç›´éƒ½æ˜¯é‡‡ç”¨çš„äº’æ–¥é”æ–¹æ¡ˆã€‚</p><pre><code>public class Test {
  long count = 0;
  void add10K() {
    int idx = 0;
    while(idx++ &lt; 10000) {
      count += 1;
    }
  }
}
</code></pre><p>å…¶å®å¯¹äºç®€å•çš„åŸå­æ€§é—®é¢˜ï¼Œè¿˜æœ‰ä¸€ç§<strong>æ— é”æ–¹æ¡ˆ</strong>ã€‚Java SDKå¹¶å‘åŒ…å°†è¿™ç§æ— é”æ–¹æ¡ˆå°è£…æç‚¼ä¹‹åï¼Œå®ç°äº†ä¸€ç³»åˆ—çš„åŸå­ç±»ã€‚ä¸è¿‡ï¼Œåœ¨æ·±å…¥ä»‹ç»åŸå­ç±»çš„å®ç°ä¹‹å‰ï¼Œæˆ‘ä»¬å…ˆçœ‹çœ‹å¦‚ä½•åˆ©ç”¨åŸå­ç±»è§£å†³ç´¯åŠ å™¨é—®é¢˜ï¼Œè¿™æ ·ä½ ä¼šå¯¹åŸå­ç±»æœ‰ä¸ªåˆæ­¥çš„è®¤è¯†ã€‚</p><p>åœ¨ä¸‹é¢çš„ä»£ç ä¸­ï¼Œæˆ‘ä»¬å°†åŸæ¥çš„longå‹å˜é‡countæ›¿æ¢ä¸ºäº†åŸå­ç±»AtomicLongï¼ŒåŸæ¥çš„ <code>count +=1</code> æ›¿æ¢æˆäº† count.getAndIncrement()ï¼Œä»…éœ€è¦è¿™ä¸¤å¤„ç®€å•çš„æ”¹åŠ¨å°±èƒ½ä½¿add10K()æ–¹æ³•å˜æˆçº¿ç¨‹å®‰å…¨çš„ï¼ŒåŸå­ç±»çš„ä½¿ç”¨è¿˜æ˜¯æŒºç®€å•çš„ã€‚</p><pre><code>public class Test {
  AtomicLong count = 
    new AtomicLong(0);
  void add10K() {
    int idx = 0;
    while(idx++ &lt; 10000) {
      count.getAndIncrement();
    }
  }
}
</code></pre><p>æ— é”æ–¹æ¡ˆç›¸å¯¹äº’æ–¥é”æ–¹æ¡ˆï¼Œæœ€å¤§çš„å¥½å¤„å°±æ˜¯<strong>æ€§èƒ½</strong>ã€‚äº’æ–¥é”æ–¹æ¡ˆä¸ºäº†ä¿è¯äº’æ–¥æ€§ï¼Œéœ€è¦æ‰§è¡ŒåŠ é”ã€è§£é”æ“ä½œï¼Œè€ŒåŠ é”ã€è§£é”æ“ä½œæœ¬èº«å°±æ¶ˆè€—æ€§èƒ½ï¼›åŒæ—¶æ‹¿ä¸åˆ°é”çš„çº¿ç¨‹è¿˜ä¼šè¿›å…¥é˜»å¡çŠ¶æ€ï¼Œè¿›è€Œè§¦å‘çº¿ç¨‹åˆ‡æ¢ï¼Œçº¿ç¨‹åˆ‡æ¢å¯¹æ€§èƒ½çš„æ¶ˆè€—ä¹Ÿå¾ˆå¤§ã€‚ ç›¸æ¯”ä¹‹ä¸‹ï¼Œæ— é”æ–¹æ¡ˆåˆ™å®Œå…¨æ²¡æœ‰åŠ é”ã€è§£é”çš„æ€§èƒ½æ¶ˆè€—ï¼ŒåŒæ—¶è¿˜èƒ½ä¿è¯äº’æ–¥æ€§ï¼Œæ—¢è§£å†³äº†é—®é¢˜ï¼Œåˆæ²¡æœ‰å¸¦æ¥æ–°çš„é—®é¢˜ï¼Œå¯è°“ç»ä½³æ–¹æ¡ˆã€‚é‚£å®ƒæ˜¯å¦‚ä½•åšåˆ°çš„å‘¢ï¼Ÿ</p><!-- [[[read_end]]] --><h2>æ— é”æ–¹æ¡ˆçš„å®ç°åŸç†</h2><p>å…¶å®åŸå­ç±»æ€§èƒ½é«˜çš„ç§˜å¯†å¾ˆç®€å•ï¼Œç¡¬ä»¶æ”¯æŒè€Œå·²ã€‚CPUä¸ºäº†è§£å†³å¹¶å‘é—®é¢˜ï¼Œæä¾›äº†CASæŒ‡ä»¤ï¼ˆCASï¼Œå…¨ç§°æ˜¯Compare And Swapï¼Œå³â€œæ¯”è¾ƒå¹¶äº¤æ¢â€ï¼‰ã€‚CASæŒ‡ä»¤åŒ…å«3ä¸ªå‚æ•°ï¼šå…±äº«å˜é‡çš„å†…å­˜åœ°å€Aã€ç”¨äºæ¯”è¾ƒçš„å€¼Bå’Œå…±äº«å˜é‡çš„æ–°å€¼Cï¼›å¹¶ä¸”åªæœ‰å½“å†…å­˜ä¸­åœ°å€Aå¤„çš„å€¼ç­‰äºBæ—¶ï¼Œæ‰èƒ½å°†å†…å­˜ä¸­åœ°å€Aå¤„çš„å€¼æ›´æ–°ä¸ºæ–°å€¼Cã€‚<strong>ä½œä¸ºä¸€æ¡CPUæŒ‡ä»¤ï¼ŒCASæŒ‡ä»¤æœ¬èº«æ˜¯èƒ½å¤Ÿä¿è¯åŸå­æ€§çš„</strong>ã€‚</p><p>ä½ å¯ä»¥é€šè¿‡ä¸‹é¢CASæŒ‡ä»¤çš„æ¨¡æ‹Ÿä»£ç æ¥ç†è§£CASçš„å·¥ä½œåŸç†ã€‚åœ¨ä¸‹é¢çš„æ¨¡æ‹Ÿç¨‹åºä¸­æœ‰ä¸¤ä¸ªå‚æ•°ï¼Œä¸€ä¸ªæ˜¯æœŸæœ›å€¼expectï¼Œå¦ä¸€ä¸ªæ˜¯éœ€è¦å†™å…¥çš„æ–°å€¼newValueï¼Œ<strong>åªæœ‰å½“ç›®å‰countçš„å€¼å’ŒæœŸæœ›å€¼expectç›¸ç­‰æ—¶ï¼Œæ‰ä¼šå°†countæ›´æ–°ä¸ºnewValue</strong>ã€‚</p><pre><code>class SimulatedCAS{
  int countï¼›
  synchronized int cas(
    int expect, int newValue){
    // è¯»ç›®å‰countçš„å€¼
    int curValue = count;
    // æ¯”è¾ƒç›®å‰countå€¼æ˜¯å¦==æœŸæœ›å€¼
    if(curValue == expect){
      // å¦‚æœæ˜¯ï¼Œåˆ™æ›´æ–°countçš„å€¼
      count = newValue;
    }
    // è¿”å›å†™å…¥å‰çš„å€¼
    return curValue;
  }
}
</code></pre><p>ä½ ä»”ç»†åœ°å†æ¬¡æ€è€ƒä¸€ä¸‹è¿™å¥è¯ï¼Œâ€œ<strong>åªæœ‰å½“ç›®å‰countçš„å€¼å’ŒæœŸæœ›å€¼expectç›¸ç­‰æ—¶ï¼Œæ‰ä¼šå°†countæ›´æ–°ä¸ºnewValueã€‚</strong>â€è¦æ€ä¹ˆç†è§£è¿™å¥è¯å‘¢ï¼Ÿ</p><p>å¯¹äºå‰é¢æåˆ°çš„ç´¯åŠ å™¨çš„ä¾‹å­ï¼Œ<code>count += 1</code> çš„ä¸€ä¸ªæ ¸å¿ƒé—®é¢˜æ˜¯ï¼šåŸºäºå†…å­˜ä¸­countçš„å½“å‰å€¼Aè®¡ç®—å‡ºæ¥çš„count+=1ä¸ºA+1ï¼Œåœ¨å°†A+1å†™å…¥å†…å­˜çš„æ—¶å€™ï¼Œå¾ˆå¯èƒ½æ­¤æ—¶å†…å­˜ä¸­countå·²ç»è¢«å…¶ä»–çº¿ç¨‹æ›´æ–°è¿‡äº†ï¼Œè¿™æ ·å°±ä¼šå¯¼è‡´é”™è¯¯åœ°è¦†ç›–å…¶ä»–çº¿ç¨‹å†™å…¥çš„å€¼ï¼ˆå¦‚æœä½ è§‰å¾—ç†è§£èµ·æ¥è¿˜æœ‰å›°éš¾ï¼Œå»ºè®®ä½ å†é‡æ–°çœ‹çœ‹<a href="https://time.geekbang.org/column/article/83682">ã€Š01 | å¯è§æ€§ã€åŸå­æ€§å’Œæœ‰åºæ€§é—®é¢˜ï¼šå¹¶å‘ç¼–ç¨‹Bugçš„æºå¤´ã€‹</a>ï¼‰ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œåªæœ‰å½“å†…å­˜ä¸­countçš„å€¼ç­‰äºæœŸæœ›å€¼Aæ—¶ï¼Œæ‰èƒ½å°†å†…å­˜ä¸­countçš„å€¼æ›´æ–°ä¸ºè®¡ç®—ç»“æœA+1ï¼Œè¿™ä¸å°±æ˜¯CASçš„è¯­ä¹‰å—ï¼</p><p>ä½¿ç”¨CASæ¥è§£å†³å¹¶å‘é—®é¢˜ï¼Œä¸€èˆ¬éƒ½ä¼šä¼´éšç€è‡ªæ—‹ï¼Œè€Œæ‰€è°“è‡ªæ—‹ï¼Œå…¶å®å°±æ˜¯å¾ªç¯å°è¯•ã€‚ä¾‹å¦‚ï¼Œå®ç°ä¸€ä¸ªçº¿ç¨‹å®‰å…¨çš„<code>count += 1</code>æ“ä½œï¼Œâ€œCAS+è‡ªæ—‹â€çš„å®ç°æ–¹æ¡ˆå¦‚ä¸‹æ‰€ç¤ºï¼Œé¦–å…ˆè®¡ç®—newValue = count+1ï¼Œå¦‚æœcas(count,newValue)è¿”å›çš„å€¼ä¸ç­‰äºcountï¼Œåˆ™æ„å‘³ç€çº¿ç¨‹åœ¨æ‰§è¡Œå®Œä»£ç â‘ å¤„ä¹‹åï¼Œæ‰§è¡Œä»£ç â‘¡å¤„ä¹‹å‰ï¼Œcountçš„å€¼è¢«å…¶ä»–çº¿ç¨‹æ›´æ–°è¿‡ã€‚é‚£æ­¤æ—¶è¯¥æ€ä¹ˆå¤„ç†å‘¢ï¼Ÿå¯ä»¥é‡‡ç”¨è‡ªæ—‹æ–¹æ¡ˆï¼Œå°±åƒä¸‹é¢ä»£ç ä¸­å±•ç¤ºçš„ï¼Œå¯ä»¥é‡æ–°è¯»countæœ€æ–°çš„å€¼æ¥è®¡ç®—newValueå¹¶å°è¯•å†æ¬¡æ›´æ–°ï¼Œç›´åˆ°æˆåŠŸã€‚</p><pre><code>class SimulatedCAS{
  volatile int count;
  // å®ç°count+=1
  addOne(){
    do {
      newValue = count+1; //â‘ 
    }while(count !=
      cas(count,newValue) //â‘¡
  }
  // æ¨¡æ‹Ÿå®ç°CASï¼Œä»…ç”¨æ¥å¸®åŠ©ç†è§£
  synchronized int cas(
    int expect, int newValue){
    // è¯»ç›®å‰countçš„å€¼
    int curValue = count;
    // æ¯”è¾ƒç›®å‰countå€¼æ˜¯å¦==æœŸæœ›å€¼
    if(curValue == expect){
      // å¦‚æœæ˜¯ï¼Œåˆ™æ›´æ–°countçš„å€¼
      count= newValue;
    }
    // è¿”å›å†™å…¥å‰çš„å€¼
    return curValue;
  }
}
</code></pre><p>é€šè¿‡ä¸Šé¢çš„ç¤ºä¾‹ä»£ç ï¼Œæƒ³å¿…ä½ å·²ç»å‘ç°äº†ï¼ŒCASè¿™ç§æ— é”æ–¹æ¡ˆï¼Œå®Œå…¨æ²¡æœ‰åŠ é”ã€è§£é”æ“ä½œï¼Œå³ä¾¿ä¸¤ä¸ªçº¿ç¨‹å®Œå…¨åŒæ—¶æ‰§è¡ŒaddOne()æ–¹æ³•ï¼Œä¹Ÿä¸ä¼šæœ‰çº¿ç¨‹è¢«é˜»å¡ï¼Œæ‰€ä»¥ç›¸å¯¹äºäº’æ–¥é”æ–¹æ¡ˆæ¥è¯´ï¼Œæ€§èƒ½å¥½äº†å¾ˆå¤šã€‚</p><p>ä½†æ˜¯åœ¨CASæ–¹æ¡ˆä¸­ï¼Œæœ‰ä¸€ä¸ªé—®é¢˜å¯èƒ½ä¼šå¸¸è¢«ä½ å¿½ç•¥ï¼Œé‚£å°±æ˜¯<strong>ABA</strong>çš„é—®é¢˜ã€‚ä»€ä¹ˆæ˜¯ABAé—®é¢˜å‘¢ï¼Ÿ</p><p>å‰é¢æˆ‘ä»¬æåˆ°â€œå¦‚æœcas(count,newValue)è¿”å›çš„å€¼<strong>ä¸ç­‰äº</strong>countï¼Œæ„å‘³ç€çº¿ç¨‹åœ¨æ‰§è¡Œå®Œä»£ç â‘ å¤„ä¹‹åï¼Œæ‰§è¡Œä»£ç â‘¡å¤„ä¹‹å‰ï¼Œcountçš„å€¼è¢«å…¶ä»–çº¿ç¨‹<strong>æ›´æ–°è¿‡</strong>â€ï¼Œé‚£å¦‚æœcas(count,newValue)è¿”å›çš„å€¼<strong>ç­‰äº</strong>countï¼Œæ˜¯å¦å°±èƒ½å¤Ÿè®¤ä¸ºcountçš„å€¼æ²¡æœ‰è¢«å…¶ä»–çº¿ç¨‹<strong>æ›´æ–°è¿‡</strong>å‘¢ï¼Ÿæ˜¾ç„¶ä¸æ˜¯çš„ï¼Œå‡è®¾countåŸæœ¬æ˜¯Aï¼Œçº¿ç¨‹T1åœ¨æ‰§è¡Œå®Œä»£ç â‘ å¤„ä¹‹åï¼Œæ‰§è¡Œä»£ç â‘¡å¤„ä¹‹å‰ï¼Œæœ‰å¯èƒ½countè¢«çº¿ç¨‹T2æ›´æ–°æˆäº†Bï¼Œä¹‹ååˆè¢«T3æ›´æ–°å›äº†Aï¼Œè¿™æ ·çº¿ç¨‹T1è™½ç„¶çœ‹åˆ°çš„ä¸€ç›´æ˜¯Aï¼Œä½†æ˜¯å…¶å®å·²ç»è¢«å…¶ä»–çº¿ç¨‹æ›´æ–°è¿‡äº†ï¼Œè¿™å°±æ˜¯ABAé—®é¢˜ã€‚</p><p>å¯èƒ½å¤§å¤šæ•°æƒ…å†µä¸‹æˆ‘ä»¬å¹¶ä¸å…³å¿ƒABAé—®é¢˜ï¼Œä¾‹å¦‚æ•°å€¼çš„åŸå­é€’å¢ï¼Œä½†ä¹Ÿä¸èƒ½æ‰€æœ‰æƒ…å†µä¸‹éƒ½ä¸å…³å¿ƒï¼Œä¾‹å¦‚åŸå­åŒ–çš„æ›´æ–°å¯¹è±¡å¾ˆå¯èƒ½å°±éœ€è¦å…³å¿ƒABAé—®é¢˜ï¼Œå› ä¸ºä¸¤ä¸ªAè™½ç„¶ç›¸ç­‰ï¼Œä½†æ˜¯ç¬¬äºŒä¸ªAçš„å±æ€§å¯èƒ½å·²ç»å‘ç”Ÿå˜åŒ–äº†ã€‚æ‰€ä»¥åœ¨ä½¿ç”¨CASæ–¹æ¡ˆçš„æ—¶å€™ï¼Œä¸€å®šè¦å…ˆcheckä¸€ä¸‹ã€‚</p><h2>çœ‹Javaå¦‚ä½•å®ç°åŸå­åŒ–çš„count += 1</h2><p>åœ¨æœ¬æ–‡å¼€å§‹éƒ¨åˆ†ï¼Œæˆ‘ä»¬ä½¿ç”¨åŸå­ç±»AtomicLongçš„getAndIncrement()æ–¹æ³•æ›¿ä»£äº†<code>count += 1</code>ï¼Œä»è€Œå®ç°äº†çº¿ç¨‹å®‰å…¨ã€‚åŸå­ç±»AtomicLongçš„getAndIncrement()æ–¹æ³•å†…éƒ¨å°±æ˜¯åŸºäºCASå®ç°çš„ï¼Œä¸‹é¢æˆ‘ä»¬æ¥çœ‹çœ‹Javaæ˜¯å¦‚ä½•ä½¿ç”¨CASæ¥å®ç°åŸå­åŒ–çš„<code>count += 1</code>çš„ã€‚</p><p>åœ¨Java 1.8ç‰ˆæœ¬ä¸­ï¼ŒgetAndIncrement()æ–¹æ³•ä¼šè½¬è°ƒunsafe.getAndAddLong()æ–¹æ³•ã€‚è¿™é‡Œthiså’ŒvalueOffsetä¸¤ä¸ªå‚æ•°å¯ä»¥å”¯ä¸€ç¡®å®šå…±äº«å˜é‡çš„å†…å­˜åœ°å€ã€‚</p><pre><code>final long getAndIncrement() {
  return unsafe.getAndAddLong(
    this, valueOffset, 1L);
}
</code></pre><p>unsafe.getAndAddLong()æ–¹æ³•çš„æºç å¦‚ä¸‹ï¼Œè¯¥æ–¹æ³•é¦–å…ˆä¼šåœ¨å†…å­˜ä¸­è¯»å–å…±äº«å˜é‡çš„å€¼ï¼Œä¹‹åå¾ªç¯è°ƒç”¨compareAndSwapLong()æ–¹æ³•æ¥å°è¯•è®¾ç½®å…±äº«å˜é‡çš„å€¼ï¼Œç›´åˆ°æˆåŠŸä¸ºæ­¢ã€‚compareAndSwapLong()æ˜¯ä¸€ä¸ªnativeæ–¹æ³•ï¼Œåªæœ‰å½“å†…å­˜ä¸­å…±äº«å˜é‡çš„å€¼ç­‰äºexpectedæ—¶ï¼Œæ‰ä¼šå°†å…±äº«å˜é‡çš„å€¼æ›´æ–°ä¸ºxï¼Œå¹¶ä¸”è¿”å›trueï¼›å¦åˆ™è¿”å›fasleã€‚compareAndSwapLongçš„è¯­ä¹‰å’ŒCASæŒ‡ä»¤çš„è¯­ä¹‰çš„å·®åˆ«ä»…ä»…æ˜¯è¿”å›å€¼ä¸åŒè€Œå·²ã€‚</p><pre><code>public final long getAndAddLong(
  Object o, long offset, long delta){
  long v;
  do {
    // è¯»å–å†…å­˜ä¸­çš„å€¼
    v = getLongVolatile(o, offset);
  } while (!compareAndSwapLong(
      o, offset, v, v + delta));
  return v;
}
//åŸå­æ€§åœ°å°†å˜é‡æ›´æ–°ä¸ºx
//æ¡ä»¶æ˜¯å†…å­˜ä¸­çš„å€¼ç­‰äºexpected
//æ›´æ–°æˆåŠŸåˆ™è¿”å›true
native boolean compareAndSwapLong(
  Object o, long offset, 
  long expected,
  long x);
</code></pre><p>å¦å¤–ï¼Œéœ€è¦ä½ æ³¨æ„çš„æ˜¯ï¼ŒgetAndAddLong()æ–¹æ³•çš„å®ç°ï¼ŒåŸºæœ¬ä¸Šå°±æ˜¯CASä½¿ç”¨çš„ç»å…¸èŒƒä¾‹ã€‚æ‰€ä»¥è¯·ä½ å†æ¬¡ä½“ä¼šä¸‹é¢è¿™æ®µæŠ½è±¡åçš„ä»£ç ç‰‡æ®µï¼Œå®ƒåœ¨å¾ˆå¤šæ— é”ç¨‹åºä¸­ç»å¸¸å‡ºç°ã€‚Javaæä¾›çš„åŸå­ç±»é‡Œé¢CASä¸€èˆ¬è¢«å®ç°ä¸ºcompareAndSet()ï¼ŒcompareAndSet()çš„è¯­ä¹‰å’ŒCASæŒ‡ä»¤çš„è¯­ä¹‰çš„å·®åˆ«ä»…ä»…æ˜¯è¿”å›å€¼ä¸åŒè€Œå·²ï¼ŒcompareAndSet()é‡Œé¢å¦‚æœæ›´æ–°æˆåŠŸï¼Œåˆ™ä¼šè¿”å›trueï¼Œå¦åˆ™è¿”å›falseã€‚</p><pre><code>do {
  // è·å–å½“å‰å€¼
  oldV = xxxxï¼›
  // æ ¹æ®å½“å‰å€¼è®¡ç®—æ–°å€¼
  newV = ...oldV...
}while(!compareAndSet(oldV,newV);
</code></pre><h2>åŸå­ç±»æ¦‚è§ˆ</h2><p>Java SDKå¹¶å‘åŒ…é‡Œæä¾›çš„åŸå­ç±»å†…å®¹å¾ˆä¸°å¯Œï¼Œæˆ‘ä»¬å¯ä»¥å°†å®ƒä»¬åˆ†ä¸ºäº”ä¸ªç±»åˆ«ï¼š<strong>åŸå­åŒ–çš„åŸºæœ¬æ•°æ®ç±»å‹ã€åŸå­åŒ–çš„å¯¹è±¡å¼•ç”¨ç±»å‹ã€åŸå­åŒ–æ•°ç»„ã€åŸå­åŒ–å¯¹è±¡å±æ€§æ›´æ–°å™¨</strong>å’Œ<strong>åŸå­åŒ–çš„ç´¯åŠ å™¨</strong>ã€‚è¿™äº”ä¸ªç±»åˆ«æä¾›çš„æ–¹æ³•åŸºæœ¬ä¸Šæ˜¯ç›¸ä¼¼çš„ï¼Œå¹¶ä¸”æ¯ä¸ªç±»åˆ«éƒ½æœ‰è‹¥å¹²åŸå­ç±»ï¼Œä½ å¯ä»¥é€šè¿‡ä¸‹é¢çš„åŸå­ç±»ç»„æˆæ¦‚è§ˆå›¾æ¥è·å¾—ä¸€ä¸ªå…¨å±€çš„å°è±¡ã€‚ä¸‹é¢æˆ‘ä»¬è¯¦ç»†è§£è¯»è¿™äº”ä¸ªç±»åˆ«ã€‚</p><p><img src="https://static001.geekbang.org/resource/image/00/4a/007a32583fbf519469462fe61805eb4a.png" alt=""></p><center><span class="reference">åŸå­ç±»ç»„æˆæ¦‚è§ˆå›¾</span></center><h3>1. åŸå­åŒ–çš„åŸºæœ¬æ•°æ®ç±»å‹</h3><p>ç›¸å…³å®ç°æœ‰AtomicBooleanã€AtomicIntegerå’ŒAtomicLongï¼Œæä¾›çš„æ–¹æ³•ä¸»è¦æœ‰ä»¥ä¸‹è¿™äº›ï¼Œè¯¦æƒ…ä½ å¯ä»¥å‚è€ƒSDKçš„æºä»£ç ï¼Œéƒ½å¾ˆç®€å•ï¼Œè¿™é‡Œå°±ä¸è¯¦ç»†ä»‹ç»äº†ã€‚</p><pre><code>getAndIncrement() //åŸå­åŒ–i++
getAndDecrement() //åŸå­åŒ–çš„i--
incrementAndGet() //åŸå­åŒ–çš„++i
decrementAndGet() //åŸå­åŒ–çš„--i
//å½“å‰å€¼+=deltaï¼Œè¿”å›+=å‰çš„å€¼
getAndAdd(delta) 
//å½“å‰å€¼+=deltaï¼Œè¿”å›+=åçš„å€¼
addAndGet(delta)
//CASæ“ä½œï¼Œè¿”å›æ˜¯å¦æˆåŠŸ
compareAndSet(expect, update)
//ä»¥ä¸‹å››ä¸ªæ–¹æ³•
//æ–°å€¼å¯ä»¥é€šè¿‡ä¼ å…¥funcå‡½æ•°æ¥è®¡ç®—
getAndUpdate(func)
updateAndGet(func)
getAndAccumulate(x,func)
accumulateAndGet(x,func)
</code></pre><h3>2. åŸå­åŒ–çš„å¯¹è±¡å¼•ç”¨ç±»å‹</h3><p>ç›¸å…³å®ç°æœ‰AtomicReferenceã€AtomicStampedReferenceå’ŒAtomicMarkableReferenceï¼Œåˆ©ç”¨å®ƒä»¬å¯ä»¥å®ç°å¯¹è±¡å¼•ç”¨çš„åŸå­åŒ–æ›´æ–°ã€‚AtomicReferenceæä¾›çš„æ–¹æ³•å’ŒåŸå­åŒ–çš„åŸºæœ¬æ•°æ®ç±»å‹å·®ä¸å¤šï¼Œè¿™é‡Œä¸å†èµ˜è¿°ã€‚ä¸è¿‡éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œå¯¹è±¡å¼•ç”¨çš„æ›´æ–°éœ€è¦é‡ç‚¹å…³æ³¨ABAé—®é¢˜ï¼ŒAtomicStampedReferenceå’ŒAtomicMarkableReferenceè¿™ä¸¤ä¸ªåŸå­ç±»å¯ä»¥è§£å†³ABAé—®é¢˜ã€‚</p><p>è§£å†³ABAé—®é¢˜çš„æ€è·¯å…¶å®å¾ˆç®€å•ï¼Œå¢åŠ ä¸€ä¸ªç‰ˆæœ¬å·ç»´åº¦å°±å¯ä»¥äº†ï¼Œè¿™ä¸ªå’Œæˆ‘ä»¬åœ¨<a href="https://time.geekbang.org/column/article/89456">ã€Š18 | StampedLockï¼šæœ‰æ²¡æœ‰æ¯”è¯»å†™é”æ›´å¿«çš„é”ï¼Ÿã€‹</a>ä»‹ç»çš„ä¹è§‚é”æœºåˆ¶å¾ˆç±»ä¼¼ï¼Œæ¯æ¬¡æ‰§è¡ŒCASæ“ä½œï¼Œé™„åŠ å†æ›´æ–°ä¸€ä¸ªç‰ˆæœ¬å·ï¼Œåªè¦ä¿è¯ç‰ˆæœ¬å·æ˜¯é€’å¢çš„ï¼Œé‚£ä¹ˆå³ä¾¿Aå˜æˆBä¹‹åå†å˜å›Aï¼Œç‰ˆæœ¬å·ä¹Ÿä¸ä¼šå˜å›æ¥ï¼ˆç‰ˆæœ¬å·é€’å¢çš„ï¼‰ã€‚AtomicStampedReferenceå®ç°çš„CASæ–¹æ³•å°±å¢åŠ äº†ç‰ˆæœ¬å·å‚æ•°ï¼Œæ–¹æ³•ç­¾åå¦‚ä¸‹ï¼š</p><pre><code>boolean compareAndSet(
  V expectedReference,
  V newReference,
  int expectedStamp,
  int newStamp) 
</code></pre><p>AtomicMarkableReferenceçš„å®ç°æœºåˆ¶åˆ™æ›´ç®€å•ï¼Œå°†ç‰ˆæœ¬å·ç®€åŒ–æˆäº†ä¸€ä¸ªBooleanå€¼ï¼Œæ–¹æ³•ç­¾åå¦‚ä¸‹ï¼š</p><pre><code>boolean compareAndSet(
  V expectedReference,
  V newReference,
  boolean expectedMark,
  boolean newMark)
</code></pre><h3>3. åŸå­åŒ–æ•°ç»„</h3><p>ç›¸å…³å®ç°æœ‰AtomicIntegerArrayã€AtomicLongArrayå’ŒAtomicReferenceArrayï¼Œåˆ©ç”¨è¿™äº›åŸå­ç±»ï¼Œæˆ‘ä»¬å¯ä»¥åŸå­åŒ–åœ°æ›´æ–°æ•°ç»„é‡Œé¢çš„æ¯ä¸€ä¸ªå…ƒç´ ã€‚è¿™äº›ç±»æä¾›çš„æ–¹æ³•å’ŒåŸå­åŒ–çš„åŸºæœ¬æ•°æ®ç±»å‹çš„åŒºåˆ«ä»…ä»…æ˜¯ï¼šæ¯ä¸ªæ–¹æ³•å¤šäº†ä¸€ä¸ªæ•°ç»„çš„ç´¢å¼•å‚æ•°ï¼Œæ‰€ä»¥è¿™é‡Œä¹Ÿä¸å†èµ˜è¿°äº†ã€‚</p><h3>4. åŸå­åŒ–å¯¹è±¡å±æ€§æ›´æ–°å™¨</h3><p>ç›¸å…³å®ç°æœ‰AtomicIntegerFieldUpdaterã€AtomicLongFieldUpdaterå’ŒAtomicReferenceFieldUpdaterï¼Œåˆ©ç”¨å®ƒä»¬å¯ä»¥åŸå­åŒ–åœ°æ›´æ–°å¯¹è±¡çš„å±æ€§ï¼Œè¿™ä¸‰ä¸ªæ–¹æ³•éƒ½æ˜¯åˆ©ç”¨åå°„æœºåˆ¶å®ç°çš„ï¼Œåˆ›å»ºæ›´æ–°å™¨çš„æ–¹æ³•å¦‚ä¸‹ï¼š</p><pre><code>public static &lt;U&gt;
AtomicXXXFieldUpdater&lt;U&gt; 
newUpdater(Class&lt;U&gt; tclass, 
  String fieldName)
</code></pre><p>éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œ<strong>å¯¹è±¡å±æ€§å¿…é¡»æ˜¯volatileç±»å‹çš„ï¼Œåªæœ‰è¿™æ ·æ‰èƒ½ä¿è¯å¯è§æ€§</strong>ï¼›å¦‚æœå¯¹è±¡å±æ€§ä¸æ˜¯volatileç±»å‹çš„ï¼ŒnewUpdater()æ–¹æ³•ä¼šæŠ›å‡ºIllegalArgumentExceptionè¿™ä¸ªè¿è¡Œæ—¶å¼‚å¸¸ã€‚</p><p>ä½ ä¼šå‘ç°newUpdater()çš„æ–¹æ³•å‚æ•°åªæœ‰ç±»çš„ä¿¡æ¯ï¼Œæ²¡æœ‰å¯¹è±¡çš„å¼•ç”¨ï¼Œè€Œæ›´æ–°<strong>å¯¹è±¡</strong>çš„å±æ€§ï¼Œä¸€å®šéœ€è¦å¯¹è±¡çš„å¼•ç”¨ï¼Œé‚£è¿™ä¸ªå‚æ•°æ˜¯åœ¨å“ªé‡Œä¼ å…¥çš„å‘¢ï¼Ÿæ˜¯åœ¨åŸå­æ“ä½œçš„æ–¹æ³•å‚æ•°ä¸­ä¼ å…¥çš„ã€‚ä¾‹å¦‚compareAndSet()è¿™ä¸ªåŸå­æ“ä½œï¼Œç›¸æ¯”åŸå­åŒ–çš„åŸºæœ¬æ•°æ®ç±»å‹å¤šäº†ä¸€ä¸ªå¯¹è±¡å¼•ç”¨objã€‚åŸå­åŒ–å¯¹è±¡å±æ€§æ›´æ–°å™¨ç›¸å…³çš„æ–¹æ³•ï¼Œç›¸æ¯”åŸå­åŒ–çš„åŸºæœ¬æ•°æ®ç±»å‹ä»…ä»…æ˜¯å¤šäº†å¯¹è±¡å¼•ç”¨å‚æ•°ï¼Œæ‰€ä»¥è¿™é‡Œä¹Ÿä¸å†èµ˜è¿°äº†ã€‚</p><pre><code>boolean compareAndSet(
  T obj, 
  int expect, 
  int update)
</code></pre><h3>5. åŸå­åŒ–çš„ç´¯åŠ å™¨</h3><p>DoubleAccumulatorã€DoubleAdderã€LongAccumulatorå’ŒLongAdderï¼Œè¿™å››ä¸ªç±»ä»…ä»…ç”¨æ¥æ‰§è¡Œç´¯åŠ æ“ä½œï¼Œç›¸æ¯”åŸå­åŒ–çš„åŸºæœ¬æ•°æ®ç±»å‹ï¼Œé€Ÿåº¦æ›´å¿«ï¼Œä½†æ˜¯ä¸æ”¯æŒcompareAndSet()æ–¹æ³•ã€‚å¦‚æœä½ ä»…ä»…éœ€è¦ç´¯åŠ æ“ä½œï¼Œä½¿ç”¨åŸå­åŒ–çš„ç´¯åŠ å™¨æ€§èƒ½ä¼šæ›´å¥½ã€‚</p><h2>æ€»ç»“</h2><p>æ— é”æ–¹æ¡ˆç›¸å¯¹äºäº’æ–¥é”æ–¹æ¡ˆï¼Œä¼˜ç‚¹éå¸¸å¤šï¼Œé¦–å…ˆæ€§èƒ½å¥½ï¼Œå…¶æ¬¡æ˜¯åŸºæœ¬ä¸ä¼šå‡ºç°æ­»é”é—®é¢˜ï¼ˆä½†å¯èƒ½å‡ºç°é¥¥é¥¿å’Œæ´»é”é—®é¢˜ï¼Œå› ä¸ºè‡ªæ—‹ä¼šåå¤é‡è¯•ï¼‰ã€‚Javaæä¾›çš„åŸå­ç±»å¤§éƒ¨åˆ†éƒ½å®ç°äº†compareAndSet()æ–¹æ³•ï¼ŒåŸºäºcompareAndSet()æ–¹æ³•ï¼Œä½ å¯ä»¥æ„å»ºè‡ªå·±çš„æ— é”æ•°æ®ç»“æ„ï¼Œä½†æ˜¯<strong>å»ºè®®ä½ ä¸è¦è¿™æ ·åšï¼Œè¿™ä¸ªå·¥ä½œæœ€å¥½è¿˜æ˜¯è®©å¤§å¸ˆä»¬å»å®Œæˆ</strong>ï¼ŒåŸå› æ˜¯æ— é”ç®—æ³•æ²¡ä½ æƒ³è±¡çš„é‚£ä¹ˆç®€å•ã€‚</p><p>Javaæä¾›çš„åŸå­ç±»èƒ½å¤Ÿè§£å†³ä¸€äº›ç®€å•çš„åŸå­æ€§é—®é¢˜ï¼Œä½†ä½ å¯èƒ½ä¼šå‘ç°ï¼Œä¸Šé¢æˆ‘ä»¬æ‰€æœ‰åŸå­ç±»çš„æ–¹æ³•éƒ½æ˜¯é’ˆå¯¹ä¸€ä¸ªå…±äº«å˜é‡çš„ï¼Œå¦‚æœä½ éœ€è¦è§£å†³å¤šä¸ªå˜é‡çš„åŸå­æ€§é—®é¢˜ï¼Œå»ºè®®è¿˜æ˜¯ä½¿ç”¨äº’æ–¥é”æ–¹æ¡ˆã€‚åŸå­ç±»è™½å¥½ï¼Œä½†ä½¿ç”¨è¦æ…ä¹‹åˆæ…ã€‚</p><h2>è¯¾åæ€è€ƒ</h2><p>ä¸‹é¢çš„ç¤ºä¾‹ä»£ç æ˜¯åˆç†åº“å­˜çš„åŸå­åŒ–å®ç°ï¼Œä»…å®ç°äº†è®¾ç½®åº“å­˜ä¸Šé™setUpper()æ–¹æ³•ï¼Œä½ è§‰å¾—setUpper()æ–¹æ³•çš„å®ç°æ˜¯å¦æ­£ç¡®å‘¢ï¼Ÿ</p><pre><code>public class SafeWM {
  class WMRange{
    final int upper;
    final int lower;
    WMRange(int upper,int lower){
    //çœç•¥æ„é€ å‡½æ•°å®ç°
    }
  }
  final AtomicReference&lt;WMRange&gt;
    rf = new AtomicReference&lt;&gt;(
      new WMRange(0,0)
    );
  // è®¾ç½®åº“å­˜ä¸Šé™
  void setUpper(int v){
    WMRange nr;
    WMRange or = rf.get();
    do{
      // æ£€æŸ¥å‚æ•°åˆæ³•æ€§
      if(v &lt; or.lower){
        throw new IllegalArgumentException();
      }
      nr = new
        WMRange(v, or.lower);
    }while(!rf.compareAndSet(or, nr));
  }
}
</code></pre><p>æ¬¢è¿åœ¨ç•™è¨€åŒºä¸æˆ‘åˆ†äº«ä½ çš„æƒ³æ³•ï¼Œä¹Ÿæ¬¢è¿ä½ åœ¨ç•™è¨€åŒºè®°å½•ä½ çš„æ€è€ƒè¿‡ç¨‹ã€‚æ„Ÿè°¢é˜…è¯»ï¼Œå¦‚æœä½ è§‰å¾—è¿™ç¯‡æ–‡ç« å¯¹ä½ æœ‰å¸®åŠ©çš„è¯ï¼Œä¹Ÿæ¬¢è¿æŠŠå®ƒåˆ†äº«ç»™æ›´å¤šçš„æœ‹å‹ã€‚</p><p><img src="https://static001.geekbang.org/resource/image/cf/aa/cf393cd748a4f0e6451807c4b61843aa.jpg" alt=""></p><h2>ç²¾é€‰ç•™è¨€ï¼š</h2>
        <ul>
        
<li>
    <div>
        <div style="color: #888;font-size:15.25px;font-weight:400;line-height:1.2">
            éƒ‘æ™¨Cc  2019-04-16 03:05:33
        </div>
        <div style="color:#353535;font-weight:400;white-space:normal;word-break:break-all;line-height:1.6">
            oræ˜¯åŸå§‹çš„ nræ˜¯newå‡ºæ¥çš„ æŒ‡å‘ä¸åŒçš„å†…å­˜åœ°å€ compareandsetçš„ç»“æœæ°¸è¿œè¿”å›false ç»“æœæ˜¯æ­»å¾ªç¯ï¼Ÿæ˜¯ä¸æ˜¯åº”è¯¥ç”¨atomicfieldreferenceï¼Ÿ [5èµ]
        </div>
        <br/>
<div>
    <div style="color:#888;font-size:15.25px;font-weight:400;line-height:1.2">ä½œè€…å›å¤2019-04-16 12:09:39</div>
    <div style="color:#353535;font-weight:400;white-space:normal;word-break:break-all;line-height:1.6">ğŸ‘ï¼Œä¸è¿‡æˆ‘è§‰å¾—æ²¡å¿…è¦ç”¨atomicfieldreference</div>
</div>
            
    </div>
</li>
            
<br/>

<li>
    <div>
        <div style="color: #888;font-size:15.25px;font-weight:400;line-height:1.2">
            å¤©æ¶¯ç…®é…’  2019-04-16 15:25:19
        </div>
        <div style="color:#353535;font-weight:400;white-space:normal;word-break:break-all;line-height:1.6">
            or = rf.get(); åº”è¯¥æ”¾åˆ°do{}å†… [2èµ]
        </div>
        
    </div>
</li>
            
<br/>

<li>
    <div>
        <div style="color: #888;font-size:15.25px;font-weight:400;line-height:1.2">
            andy  2019-04-16 16:50:13
        </div>
        <div style="color:#353535;font-weight:400;white-space:normal;word-break:break-all;line-height:1.6">
            public class SafeWM {<br>  class WMRange{<br>    final int upper;<br>    final int lower;<br>    WMRange(int upper,int lower){<br>    &#47;&#47; çœç•¥æ„é€ å‡½æ•°å®ç°<br>    }<br>  }<br>  final AtomicReference&lt;WMRange&gt;<br>    rf = new AtomicReference&lt;&gt;(<br>      new WMRange(0,0)<br>    );<br>  &#47;&#47; è®¾ç½®åº“å­˜ä¸Šé™<br>  void setUpper(int v){<br>    WMRange nr;<br>    WMRange or;<br>    do{<br>	  or = rf.get();<br>      &#47;&#47; æ£€æŸ¥å‚æ•°åˆæ³•æ€§<br>      if(v &lt; or.lower){<br>        throw new IllegalArgumentException();<br>      }<br>      nr = new<br>        WMRange(v, or.lower);<br>    }while(!rf.compareAndSet(or, nr));<br>  }<br>}<br><br> è¿™æ ·å­å¯¹å—ï¼Ÿ [1èµ]
        </div>
        <br/>
<div>
    <div style="color:#888;font-size:15.25px;font-weight:400;line-height:1.2">ä½œè€…å›å¤2019-04-16 18:53:07</div>
    <div style="color:#353535;font-weight:400;white-space:normal;word-break:break-all;line-height:1.6">å¯¹ğŸ‘<br><br></div>
</div>
            
    </div>
</li>
            
<br/>

<li>
    <div>
        <div style="color: #888;font-size:15.25px;font-weight:400;line-height:1.2">
            å¯†ç 123456  2019-04-16 08:26:23
        </div>
        <div style="color:#353535;font-weight:400;white-space:normal;word-break:break-all;line-height:1.6">
            æˆ‘è§‰å¾—å¯èƒ½ä¼šå‡ºç°æ­»å¾ªç¯ã€‚WMRange or = rf.get(); åº”è¯¥æ”¾åœ¨doé‡Œé¢ã€‚æ¯æ¬¡æ¯”è¾ƒäº¤æ¢å¤±è´¥åï¼Œé‡æ–°è·å–ä¸€æ¬¡ã€‚ [1èµ]
        </div>
        <br/>
<div>
    <div style="color:#888;font-size:15.25px;font-weight:400;line-height:1.2">ä½œè€…å›å¤2019-04-16 12:02:08</div>
    <div style="color:#353535;font-weight:400;white-space:normal;word-break:break-all;line-height:1.6">ğŸ‘</div>
</div>
            
    </div>
</li>
            
<br/>

<li>
    <div>
        <div style="color: #888;font-size:15.25px;font-weight:400;line-height:1.2">
            æ™“æ°  2019-04-17 17:51:07
        </div>
        <div style="color:#353535;font-weight:400;white-space:normal;word-break:break-all;line-height:1.6">
            è¯·é—®è€å¸ˆatomicRefrenceçš„compareAndSetæ¯”è¾ƒçš„æ—¶å€™æ˜¯æ€ä¹ˆæ¯”è¾ƒçš„ 
        </div>
        
    </div>
</li>
            
<br/>

<li>
    <div>
        <div style="color: #888;font-size:15.25px;font-weight:400;line-height:1.2">
            è¥¿è¡Œå¯ºå’•å“’å­  2019-04-17 15:41:54
        </div>
        <div style="color:#353535;font-weight:400;white-space:normal;word-break:break-all;line-height:1.6">
            è¯•äº†ä¸€ä¸‹ ç¡®å®æ˜¯æ­»å¾ªç¯ çŒœæµ‹ï¼šçº¿ç¨‹1 ä¸­ or æ˜¯åœ¨ do å¾ªç¯ä½“å¤–é¢è·å– å¦‚æœçº¿ç¨‹2æ”¹å˜äº† AtomicReference ä¸­çš„å¯¹è±¡ é‚£ä¹ˆçº¿ç¨‹1 ä¸­è°ƒç”¨çš„compareAndSetï¼ˆorï¼Œurï¼‰ or å§‹ç»ˆä¸æ˜¯çº¿ç¨‹2æ›´æ–°åçš„ å¯¼è‡´ä¸€ç›´è¿”å›false ä»è€Œæ­»å¾ªç¯ã€‚å°†rf.get()æ”¾åˆ°doå¾ªç¯ä½“å†…å°±å¥½äº†<br>  
        </div>
        
    </div>
</li>
            
<br/>

<li>
    <div>
        <div style="color: #888;font-size:15.25px;font-weight:400;line-height:1.2">
            Kenny  2019-04-17 11:01:30
        </div>
        <div style="color:#353535;font-weight:400;white-space:normal;word-break:break-all;line-height:1.6">
            è€å¸ˆä½ å¥½ï¼Œæ‚¨ä¸Šé¢æåˆ°æ— é”æ–¹æ¡ˆä¸ä¼šäº§ç”Ÿæ­»é”é—®é¢˜ï¼Œä½†æ˜¯å¯èƒ½ä¼šäº§ç”Ÿé¥¥é¥¿å’Œæ´»é”ã€‚å¯¹äºCASæ¥è¯´ï¼Œäº§ç”Ÿé¥¥é¥¿æ¯”è¾ƒå®¹æ˜“ç†è§£ï¼Œé‚£æ˜¯å¦CASä¸ä¼šäº§ç”Ÿæ´»é”ï¼Ÿæˆ‘æ˜¯è¿™æ ·ç†è§£çš„ï¼šå› ä¸ºå¦‚æœnä¸ªçº¿ç¨‹å¯¹ä¸€ä¸ªå˜é‡æ‰§è¡ŒCASï¼Œäº§ç”Ÿè‡ªæ—‹çš„æ¡ä»¶æ˜¯å˜é‡è¢«å…¶ä»–çº¿ç¨‹æ”¹äº†ï¼Œè€Œå˜é‡è¢«å…¶ä»–çº¿ç¨‹æ”¹äº†ä¹‹åï¼Œç­‰å¾…ä¿®æ”¹çš„çº¿ç¨‹å°±å˜ä¸ºN-1ï¼Œè¿™æ ·å¾ªç¯ä¸‹å»ï¼Œæœ€ç»ˆæ‰€æœ‰çš„çº¿ç¨‹éƒ½èƒ½å®Œæˆä¿®æ”¹ï¼Œæ‰€ä»¥ä¸ä¼šäº§ç”Ÿæ´»é”ï¼Ÿæ‚¨çœ‹æˆ‘ç†è§£å¾—å¯¹å—ï¼Ÿ 
        </div>
        
    </div>
</li>
            
<br/>

<li>
    <div>
        <div style="color: #888;font-size:15.25px;font-weight:400;line-height:1.2">
            åˆ˜å¿—å…µ  2019-04-17 10:09:08
        </div>
        <div style="color:#353535;font-weight:400;white-space:normal;word-break:break-all;line-height:1.6">
            è€å¸ˆï¼ŒcompareAndSwapLongæ–¹æ³•æ˜¯ä¸€ä¸ªnativeæ–¹æ³•ï¼Œæ¯”è¾ƒå…±äº«å˜é‡å’Œexpectå€¼æ˜¯å¦ç›¸ç­‰ï¼Œç›¸ç­‰æ‰è®¾ç½®æ–°çš„å€¼x, ä¸æ˜ç™½è¿™é‡Œçš„å¯¹æ¯”æ˜¯æ€ä¹ˆä¿è¯åŸå­æ€§çš„ï¼Œå¯¹æ¯”ä¹Ÿæ˜¯è¦å†è¯»ä¸€æ¬¡å…±äº«å˜é‡ï¼Œç„¶åå¯¹æ¯”å§ï¼Œå¦‚æœå…ˆè¯»å‡ºæ¥ä¹‹åå¯¹æ¯”çš„æ—¶å€™è¢«å…¶ä»–çº¿ç¨‹ä¿®æ”¹äº†ï¼Œé‚£è¿˜æ˜¯ä¼šæœ‰é—®é¢˜ 
        </div>
        
    </div>
</li>
            
<br/>

<li>
    <div>
        <div style="color: #888;font-size:15.25px;font-weight:400;line-height:1.2">
            æ¦£å±±æ¨µå®¢â„¢  2019-04-16 20:47:51
        </div>
        <div style="color:#353535;font-weight:400;white-space:normal;word-break:break-all;line-height:1.6">
            é¦–å…ˆï¼Œor=rf.get()éœ€è¦æ”¾åˆ°do{}ï¼Œæ¯æ¬¡éœ€è¦é‡æ–°è·å–ï¼Œä»¥é˜²å…¶ä»–çº¿ç¨‹æ›´æ–°è¿‡å¯¼è‡´æ­»å¾ªç¯ï¼›<br><br>ç„¶åï¼Œnræ˜¯newçš„ï¼Œæˆ‘è§‰å¾—åº”è¯¥ä¸ä¼šå‘ç”ŸABAçš„é—®é¢˜ï¼ˆreferenceçš„compareAndSetæ¯”è¾ƒçš„æ˜¯å†…å­˜åœ°å€ï¼‰ã€‚å¦å¤–ABAé—®é¢˜åº”è¯¥å®¹æ˜“å‘ç”Ÿåœ¨å€¼ç±»å‹ä¸Šå§ï¼Œå¼•ç”¨ç±»å‹çš„åº”è¯¥å‡ ä¹ä¸ä¼šå‘ç”Ÿï¼Ÿå¯¹äºå¼•ç”¨ç±»å‹ï¼Œå‡ ä¹ä¸ä¼šå‘ç”Ÿç»è¿‡è‡³å°‘ä¸¤æ¬¡newå¯¹è±¡ï¼Œæœ€åå¯¹è±¡æ”¾åœ¨äº†åŒä¸€å—orä¹‹å‰ä½¿ç”¨çš„å†…å­˜åŒºå—ä¸Šå§ï¼Ÿ<br> 
        </div>
        <br/>
<div>
    <div style="color:#888;font-size:15.25px;font-weight:400;line-height:1.2">ä½œè€…å›å¤2019-04-16 22:09:50</div>
    <div style="color:#353535;font-weight:400;white-space:normal;word-break:break-all;line-height:1.6">æˆ‘ä¹Ÿè§‰å¾—æ²¡æœ‰ABAé—®é¢˜</div>
</div>
            
    </div>
</li>
            
<br/>

<li>
    <div>
        <div style="color: #888;font-size:15.25px;font-weight:400;line-height:1.2">
            å°èåœ  2019-04-16 11:56:29
        </div>
        <div style="color:#353535;font-weight:400;white-space:normal;word-break:break-all;line-height:1.6">
            ç¬¬16è¡Œåº”è¯¥æ”¾åœ¨å¾ªç¯ä½“å†… 
        </div>
        
    </div>
</li>
            
<br/>

<li>
    <div>
        <div style="color: #888;font-size:15.25px;font-weight:400;line-height:1.2">
            å¼ å¤©å±¹  2019-04-16 11:36:24
        </div>
        <div style="color:#353535;font-weight:400;white-space:normal;word-break:break-all;line-height:1.6">
            å¦‚æœçº¿ç¨‹1 è¿è¡Œåˆ°WMRange or = rf.get();åœæ­¢ï¼Œåˆ‡æ¢åˆ°çº¿ç¨‹2 æ›´æ–°äº†å€¼ï¼Œåˆ‡æ¢å›åˆ°çº¿ç¨‹1ï¼Œè¿›å…¥å¾ªç¯å°†æ°¸è¿œæ¯”è¾ƒå¤±è´¥æ­»å¾ªç¯ï¼Œè§£å†³æ–¹æ¡ˆæ˜¯å°†è¯»å–çš„é‚£ä¸€å¥æ”¾å…¥å¾ªç¯é‡Œï¼ŒCASæ¯æ¬¡è‡ªæ—‹å¿…é¡»è¦é‡æ–°æ£€æŸ¥æ–°çš„å€¼æ‰æœ‰æ„ä¹‰ 
        </div>
        <br/>
<div>
    <div style="color:#888;font-size:15.25px;font-weight:400;line-height:1.2">ä½œè€…å›å¤2019-04-16 19:24:23</div>
    <div style="color:#353535;font-weight:400;white-space:normal;word-break:break-all;line-height:1.6">ğŸ‘<br></div>
</div>
            
    </div>
</li>
            
<br/>

<li>
    <div>
        <div style="color: #888;font-size:15.25px;font-weight:400;line-height:1.2">
            magict4  2019-04-16 11:34:35
        </div>
        <div style="color:#353535;font-weight:400;white-space:normal;word-break:break-all;line-height:1.6">
            å¯èƒ½ä¼šé™·å…¥æ­»å¾ªç¯ã€‚<br><br>çº¿ç¨‹1æ‰§è¡Œå®Œ23è¡Œä¹‹åï¼Œè¢«æš‚åœã€‚<br>çº¿ç¨‹2æ‰§è¡Œï¼Œå¹¶æˆåŠŸæ›´æ–°rfçš„å†…å®¹ã€‚<br>çº¿ç¨‹1ç»§ç»­æ‰§è¡Œï¼Œ24è¡Œwhileè¯­å¥è¿”å›ä¸ºfalse(å› ä¸ºrfå†…å®¹å·²ç»è¢«çº¿ç¨‹2æ›´æ–°)ã€‚<br>çº¿ç¨‹1é‡æ–°è¿›å…¥doå¾ªç¯ã€‚æ³¨æ„æ­¤æ—¶orå¹¶æ²¡æœ‰è¢«é‡æ–°è¯»å–ã€‚whileè¯­å¥ç»§ç»­è¿”å›falseï¼Œå¦‚æ­¤å¾€å¤ã€‚<br><br>æ„Ÿè§‰æŠŠ WMRange or = rf.get(); è¿™ä¸€è¡Œæ”¾åˆ° do å†…éƒ¨ï¼Œå°±å¯ä»¥äº†ï¼Œä¸çŸ¥é“æ˜¯å¦æ­£ç¡®ï¼Ÿ<br> 
        </div>
        <br/>
<div>
    <div style="color:#888;font-size:15.25px;font-weight:400;line-height:1.2">ä½œè€…å›å¤2019-04-16 18:58:25</div>
    <div style="color:#353535;font-weight:400;white-space:normal;word-break:break-all;line-height:1.6">æ­£ç¡®ğŸ‘<br></div>
</div>
            
    </div>
</li>
            
<br/>

<li>
    <div>
        <div style="color: #888;font-size:15.25px;font-weight:400;line-height:1.2">
            Zach_  2019-04-16 10:14:23
        </div>
        <div style="color:#353535;font-weight:400;white-space:normal;word-break:break-all;line-height:1.6">
            public class SafeWM {<br>  class WMRange{<br>    final int upper;<br>    final int lower;<br>    WMRange(int upper,int lower){<br>    &#47;&#47; çœç•¥æ„é€ å‡½æ•°å®ç°<br>    }<br>  }<br>  final AtomicReference&lt;WMRange&gt;<br>    rf = new AtomicReference&lt;&gt;(<br>      new WMRange(0,0)<br>    );<br>  &#47;&#47; è®¾ç½®åº“å­˜ä¸Šé™<br>  void setUpper(int v){<br>    WMRange nr;<br>    WMRange or = rf.get();<br>    do{<br>      &#47;&#47; æ£€æŸ¥å‚æ•°åˆæ³•æ€§<br>      if(v &lt; or.lower){<br>        throw new IllegalArgumentException();<br>      }<br>      nr = new<br>        WMRange(v, or.lower);<br>    }while(!rf.compareAndSet(or, nr));<br>  }<br>}<br><br>ä¸æ˜¯å¾ˆæ¸…æ¥šAtomicReference.CASæ¯”è¾ƒçš„æ˜¯å¯¹è±¡å†…å­˜ä¸­çš„åœ°å€ï¼Œè¿˜æ˜¯åŒ…æ‹¬äº†å±æ€§å†…å­˜ä¸­çš„åœ°å€ã€‚ æˆ‘çŒœæƒ³æ€è€ƒé¢˜è¿™é‡Œå†™çš„æ˜¯å¯¹çš„å§?<br><br>å¯æ˜¯å¦‚æœæˆ‘è¯´å®ƒæ˜¯é”™çš„ï¼Œæˆ‘åˆä¸çŸ¥é“å®ƒé”™åœ¨å“ªé‡Œã€‚ 
        </div>
        
    </div>
</li>
            
<br/>

<li>
    <div>
        <div style="color: #888;font-size:15.25px;font-weight:400;line-height:1.2">
            å‘¨æ²»æ…§  2019-04-16 09:19:35
        </div>
        <div style="color:#353535;font-weight:400;white-space:normal;word-break:break-all;line-height:1.6">
            ä¸¤ä¸ªå¯¹è±¡æ¯”è¾ƒçš„æ—¶å€™æ˜¯æ¯”è¾ƒçš„åœ°å€å€¼ï¼Œoldå’Œnewåœ°å€å€¼ä¸€ç›´æ˜¯ä¸ç­‰çš„ï¼Œè®¾ç½®ä¸Šé™åº”è¯¥æ˜¯å»æ›´æ–°å¯¹è±¡çš„å­—æ®µçš„å€¼ä¿è¯å­—æ®µå€¼çš„cas 
        </div>
        
    </div>
</li>
            
<br/>

<li>
    <div>
        <div style="color: #888;font-size:15.25px;font-weight:400;line-height:1.2">
            zhangtnty  2019-04-16 09:18:09
        </div>
        <div style="color:#353535;font-weight:400;white-space:normal;word-break:break-all;line-height:1.6">
            ç‹è€å¸ˆå¥½, æ–‡ä¸­é¢˜ç›®æˆ‘è®¤ä¸ºä¸å­˜åœ¨ ABA çš„é—®é¢˜ã€‚é—®é¢˜æ˜¯O r çš„å€¼åº”è¯¥æ”¾åœ¨ do å¾ªç¯ä½“å†…,å¦‚æœä¸¤ä¸ªçº¿ç¨‹ A , B ã€‚åŒæ—¶æ‰§è¡Œæ–¹æ³•, A æ‰§è¡Œå®Œ B å´å§‹ç»ˆæ‹¿ä¸åˆ° A çš„æ–°å€¼, è‡´ B è¿›å…¥ æ­»å¾ªç¯ã€‚<br>å¦å¤–, ç‹è€å¸ˆèƒ½å¦é’ˆå¯¹æ— é”åŸå­ç±»çš„å®é™…åº”ç”¨åœºæ™¯åˆ—ä¸¾ä¸€äº›ï¼Œè°¢è°¢ï¼<br> 
        </div>
        
    </div>
</li>
            
<br/>

<li>
    <div>
        <div style="color: #888;font-size:15.25px;font-weight:400;line-height:1.2">
            å¼ ä¸‰  2019-04-16 09:05:21
        </div>
        <div style="color:#353535;font-weight:400;white-space:normal;word-break:break-all;line-height:1.6">
            å¯¹æ–‡ä¸­ çš„ do{}while()å¾ªç¯æœ‰ç‚¹å›°æƒ‘ï¼Œä¸ºä»€ä¹ˆä¸æ˜¯while(){}? 
        </div>
        <br/>
<div>
    <div style="color:#888;font-size:15.25px;font-weight:400;line-height:1.2">ä½œè€…å›å¤2019-04-16 11:42:20</div>
    <div style="color:#353535;font-weight:400;white-space:normal;word-break:break-all;line-height:1.6">ç­‰ä»·çš„<br></div>
</div>
            
    </div>
</li>
            
<br/>

<li>
    <div>
        <div style="color: #888;font-size:15.25px;font-weight:400;line-height:1.2">
            å¼ ä¸‰  2019-04-16 09:04:30
        </div>
        <div style="color:#353535;font-weight:400;white-space:normal;word-break:break-all;line-height:1.6">
            Javaå¦‚ä½•å®ç°åŸå­åŒ–çš„count+=1ä¸­ï¼ŒgetLongVolatileï¼ˆï¼‰ä»…ä»…æ˜¯è·å–å½“å‰å€¼ï¼Œreturnå›å»çš„vå¹¶æ²¡æœ‰å¯¹å½“å‰å€¼+1å•Šï¼Ÿ<br> 
        </div>
        <br/>
<div>
    <div style="color:#888;font-size:15.25px;font-weight:400;line-height:1.2">ä½œè€…å›å¤2019-04-16 19:41:12</div>
    <div style="color:#353535;font-weight:400;white-space:normal;word-break:break-all;line-height:1.6">çœ‹ä¸€ä¸‹v+delta<br></div>
</div>
            
    </div>
</li>
            
<br/>

<li>
    <div>
        <div style="color: #888;font-size:15.25px;font-weight:400;line-height:1.2">
            è‹å¿—è¾‰  2019-04-16 08:58:41
        </div>
        <div style="color:#353535;font-weight:400;white-space:normal;word-break:break-all;line-height:1.6">
            ä¸å®‰å…¨ï¼Œå› ä¸ºcasåªèƒ½ä¿è¯å¼•ç”¨ä¸€æ ·ï¼Œæ²¡æ³•ä¿è¯å±æ€§æ²¡å˜ 
        </div>
        
    </div>
</li>
            
<br/>

<li>
    <div>
        <div style="color: #888;font-size:15.25px;font-weight:400;line-height:1.2">
            Felix Envy  2019-04-16 08:46:31
        </div>
        <div style="color:#353535;font-weight:400;white-space:normal;word-break:break-all;line-height:1.6">
            WMRange or = rf.get(); è¿™æ®µåº”è¯¥æ”¾åˆ°å¾ªç¯ä½“é‡Œé¢å»ï¼Œä¸ç„¶ä¸€æ—¦å‘ç”Ÿå¹¶å‘å°±ä¼šæœ‰çº¿ç¨‹è¿›å…¥æ­»å¾ªç¯ã€‚ 
        </div>
        
    </div>
</li>
            
<br/>

<li>
    <div>
        <div style="color: #888;font-size:15.25px;font-weight:400;line-height:1.2">
            ç‹¼  2019-04-16 08:43:26
        </div>
        <div style="color:#353535;font-weight:400;white-space:normal;word-break:break-all;line-height:1.6">
            ABAé—®é¢˜ 
        </div>
        
    </div>
</li>
            </ul>
</div>
</body>
</html>