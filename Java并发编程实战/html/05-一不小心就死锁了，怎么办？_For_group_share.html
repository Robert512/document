<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.1//EN" "http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
    <title>05-ä¸€ä¸å°å¿ƒå°±æ­»é”äº†ï¼Œæ€ä¹ˆåŠï¼Ÿ</title>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/>
        <style>
        html {
            color: #333;
            -webkit-text-size-adjust: 100%;
            -ms-text-size-adjust: 100%;
            text-rendering: optimizelegibility;
            font-family: Helvetica Neue, PingFang SC, Verdana, Microsoft Yahei, Hiragino Sans GB, Microsoft Sans Serif, WenQuanYi Micro Hei, sans-serif
        }

        html.borderbox *,
        html.borderbox :after,
        html.borderbox :before {
            box-sizing: border-box
        }

        article,
        aside,
        blockquote,
        body,
        button,
        code,
        dd,
        details,
        dl,
        dt,
        fieldset,
        figcaption,
        figure,
        footer,
        form,
        h1,
        h2,
        h3,
        h4,
        h5,
        h6,
        header,
        hr,
        input,
        legend,
        li,
        menu,
        nav,
        ol,
        p,
        pre,
        section,
        td,
        textarea,
        th,
        ul {
            margin: 0;
            padding: 0
        }

        article,
        aside,
        details,
        figcaption,
        figure,
        footer,
        header,
        menu,
        nav,
        section {
            display: block
        }

        audio,
        canvas,
        video {
            display: inline-block
        }

        body,
        button,
        input,
        select,
        textarea {
            font: 300 1em/1.8 PingFang SC, Lantinghei SC, Microsoft Yahei, Hiragino Sans GB, Microsoft Sans Serif, WenQuanYi Micro Hei, Helvetica, sans-serif
        }

        button::-moz-focus-inner,
        input::-moz-focus-inner {
            padding: 0;
            border: 0
        }

        table {
            border-collapse: collapse;
            border-spacing: 0
        }

        fieldset,
        img {
            border: 0
        }

        blockquote {
            position: relative;
            color: #999;
            font-weight: 400;
            border-left: 1px solid #1abc9c;
            padding-left: 1em;
            margin: 1em 3em 1em 2em
        }

        @media only screen and (max-width: 640px) {
            blockquote {
                margin: 1em 0
            }
        }

        abbr,
        acronym {
            border-bottom: 1px dotted;
            font-variant: normal
        }

        abbr {
            cursor: help
        }

        del {
            text-decoration: line-through
        }

        address,
        caption,
        cite,
        code,
        dfn,
        em,
        th,
        var {
            font-style: normal;
            font-weight: 400
        }

        ol,
        ul {
            list-style: none
        }

        caption,
        th {
            text-align: left
        }

        q:after,
        q:before {
            content: ""
        }

        sub,
        sup {
            font-size: 75%;
            line-height: 0;
            position: relative
        }

        :root sub,
        :root sup {
            vertical-align: baseline
        }

        sup {
            top: -.5em
        }

        sub {
            bottom: -.25em
        }

        a {
            color: #1abc9c
        }

        a:hover {
            text-decoration: underline
        }

        .typo a {
            border-bottom: 1px solid #1abc9c
        }

        .typo a:hover {
            border-bottom-color: #555;
            color: #555
        }

        .typo a:hover,
        a,
        ins {
            text-decoration: none
        }

        .typo-u,
        u {
            text-decoration: underline
        }

        mark {
            background: #fffdd1;
            border-bottom: 1px solid #ffedce;
            padding: 2px;
            margin: 0 5px
        }

        code,
        pre,
        pre tt {
            font-family: Courier, Courier New, monospace
        }

        pre {
            background: hsla(0, 0%, 97%, .7);
            border: 1px solid #ddd;
            padding: 1em 1.5em;
            display: block;
            -webkit-overflow-scrolling: touch
        }

        hr {
            border: none;
            border-bottom: 1px solid #cfcfcf;
            margin-bottom: .8em;
            height: 10px
        }

        .typo-small,
        figcaption,
        small {
            font-size: .9em;
            color: #888
        }

        b,
        strong {
            font-weight: 700;
            color: #000
        }

        [draggable] {
            cursor: move
        }

        .clearfix:after,
        .clearfix:before {
            content: "";
            display: table
        }

        .clearfix:after {
            clear: both
        }

        .clearfix {
            zoom: 1
        }

        .textwrap,
        .textwrap td,
        .textwrap th {
            word-wrap: break-word;
            word-break: break-all
        }

        .textwrap-table {
            table-layout: fixed
        }

        .serif {
            font-family: Palatino, Optima, Georgia, serif
        }

        .typo-dl,
        .typo-form,
        .typo-hr,
        .typo-ol,
        .typo-p,
        .typo-pre,
        .typo-table,
        .typo-ul,
        .typo dl,
        .typo form,
        .typo hr,
        .typo ol,
        .typo p,
        .typo pre,
        .typo table,
        .typo ul,
        blockquote {
            margin-bottom: 1rem
        }

        h1,
        h2,
        h3,
        h4,
        h5,
        h6 {
            font-family: PingFang SC, Helvetica Neue, Verdana, Microsoft Yahei, Hiragino Sans GB, Microsoft Sans Serif, WenQuanYi Micro Hei, sans-serif;
            color: #000;
            line-height: 1.35
        }

        .typo-h1,
        .typo-h2,
        .typo-h3,
        .typo-h4,
        .typo-h5,
        .typo-h6,
        .typo h1,
        .typo h2,
        .typo h3,
        .typo h4,
        .typo h5,
        .typo h6 {
            margin-top: 1.2em;
            margin-bottom: .6em;
            line-height: 1.35
        }

        .typo-h1,
        .typo h1 {
            font-size: 2em
        }

        .typo-h2,
        .typo h2 {
            font-size: 1.8em
        }

        .typo-h3,
        .typo h3 {
            font-size: 1.6em
        }

        .typo-h4,
        .typo h4 {
            font-size: 1.4em
        }

        .typo-h5,
        .typo-h6,
        .typo h5,
        .typo h6 {
            font-size: 1.2em
        }

        .typo-ul,
        .typo ul {
            margin-left: 1.3em;
            list-style: disc
        }

        .typo-ol,
        .typo ol {
            list-style: decimal;
            margin-left: 1.9em
        }

        .typo-ol ol,
        .typo-ol ul,
        .typo-ul ol,
        .typo-ul ul,
        .typo li ol,
        .typo li ul {
            margin-bottom: .8em;
            margin-left: 2em
        }

        .typo-ol ul,
        .typo-ul ul,
        .typo li ul {
            list-style: circle
        }

        .typo-table td,
        .typo-table th,
        .typo table caption,
        .typo table td,
        .typo table th {
            border: 1px solid #ddd;
            padding: .5em 1em;
            color: #666
        }

        .typo-table th,
        .typo table th {
            background: #fbfbfb
        }

        .typo-table thead th,
        .typo table thead th {
            background: hsla(0, 0%, 95%, .7)
        }

        .typo table caption {
            border-bottom: none
        }

        .typo-input,
        .typo-textarea {
            -webkit-appearance: none;
            border-radius: 0
        }

        .typo-em,
        .typo em,
        caption,
        legend {
            color: #000;
            font-weight: inherit
        }

        .typo-em {
            position: relative
        }

        .typo-em:after {
            position: absolute;
            top: .65em;
            left: 0;
            width: 100%;
            overflow: hidden;
            white-space: nowrap;
            content: "\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB"
        }

        .typo img {
            max-width: 100%
        }

        .common-content {
            font-weight: 400;
            color: #353535;
            line-height: 1.75rem;
            white-space: normal;
            word-break: normal;
            font-size: 1rem
        }

        .common-content img {
            display: block;
            max-width: 100%;
            background-color: #eee
        }

        .common-content audio,
        .common-content video {
            width: 100%;
            background-color: #eee
        }

        .common-content center,
        .common-content font {
            margin-top: 1rem;
            display: inline-block
        }

        .common-content center {
            width: 100%
        }

        .common-content pre {
            margin-top: 1rem;
            padding-left: 0;
            padding-right: 0;
            position: relative;
            overflow: hidden
        }

        .common-content pre code {
            font-size: .8rem;
            font-family: Consolas, Liberation Mono, Menlo, monospace, Courier;
            display: block;
            width: 100%;
            box-sizing: border-box;
            padding-left: 1rem;
            padding-right: 1rem;
            overflow-x: auto
        }

        .common-content hr {
            border: none;
            margin-top: 1.5rem;
            margin-bottom: 1.5rem;
            border-top: 1px solid #f5f5f5;
            height: 1px;
            background: none
        }

        .common-content b,
        .common-content h1,
        .common-content h2,
        .common-content h3,
        .common-content h4,
        .common-content h5,
        .common-content strong {
            font-weight: 700
        }

        .common-content h1,
        .common-content h2 {
            font-size: 1.125rem;
            margin-bottom: .45rem
        }

        .common-content h3,
        .common-content h4,
        .common-content h5 {
            font-size: 1rem;
            margin-bottom: .45rem
        }

        .common-content p {
            font-weight: 400;
            color: #353535;
            margin-top: .15rem
        }

        .common-content .orange {
            color: #ff5a05
        }

        .common-content .reference {
            font-size: 1rem;
            color: #888
        }

        .custom-rich-content h1 {
            margin-top: 0;
            font-weight: 400;
            font-size: 15.25px;
            border-bottom: 1px solid #eee;
            line-height: 2.8
        }

        .custom-rich-content li,
        .custom-rich-content p {
            font-size: 14px;
            color: #888;
            line-height: 1.6
        }

        table.hljs-ln {
            margin-bottom: 0;
            border-spacing: 0;
            border-collapse: collapse
        }

        table.hljs-ln,
        table.hljs-ln tbody,
        table.hljs-ln td,
        table.hljs-ln tr {
            box-sizing: border-box
        }

        table.hljs-ln td {
            padding: 0;
            border: 0
        }

        table.hljs-ln td.hljs-ln-numbers {
            min-width: 15px;
            color: rgba(27, 31, 35, .3);
            text-align: right;
            white-space: nowrap;
            cursor: pointer;
            user-select: none
        }

        table.hljs-ln td.hljs-ln-code,
        table.hljs-ln td.hljs-ln-numbers {
            font-family: SFMono-Regular, Consolas, Liberation Mono, Menlo, Courier, monospace;
            font-size: 12px;
            line-height: 20px;
            vertical-align: top
        }

        table.hljs-ln td.hljs-ln-code {
            position: relative;
            padding-right: 10px;
            padding-left: 10px;
            overflow: visible;
            color: #24292e;
            word-wrap: normal;
            white-space: pre
        }

        video::-webkit-media-controls {
            overflow: hidden !important
        }

        video::-webkit-media-controls-enclosure {
            width: calc(100% + 32px);
            margin-left: auto
        }

        ._29HP61GA_0 {
            max-width:800px;
            margin:0 auto;
            margin-bottom: 20px;
            font-weight: 400;
            color: #353535;
            line-height: 1.76;
            white-space: normal;
            word-break: normal;
            font-size: 17px;
            -webkit-transition: background-color .3s ease;
            transition: background-color .3s ease
        }

        ._29HP61GA_0 .MathJax_Display {
            overflow: auto
        }

        ._29HP61GA_0 .poster {
            position: fixed;
            left: -10000px;
            top: -10000px;
            overflow: hidden;
            padding: 1rem;
            background: #ececec
        }

        ._29HP61GA_0 .richcontent-pre-copy {
            font-size: 13px;
            color: #888;
            position: absolute;
            right: 1em;
            top: .5em;
            cursor: pointer;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none
        }

        ._29HP61GA_0 .richcontent-pre-copy .iconfont {
            font-size: 12px;
            margin-right: .2em
        }

        ._29HP61GA_0 a {
            color: #fa8919;
            border-bottom: 1px solid #fa8919
        }

        ._29HP61GA_0 img {
            display: block;
            max-width: 100%;
            position: relative;
            left: 50%;
            -webkit-transform: translateX(-50%);
            transform: translateX(-50%);
            background-color: #eee;
            vertical-align: top;
            border-radius: 0
        }

        ._29HP61GA_0 audio,
        ._29HP61GA_0 video {
            width: 100%;
            background-color: #eee
        }

        ._29HP61GA_0 pre {
            margin-top: 16px;
            padding: 34px 0 0;
            margin-bottom: 30px;
            position: relative;
            border-radius: 6px;
            background: rgba(246, 247, 251, .749);
            border: 0
        }

        ._29HP61GA_0 pre code {
            font-size: 12px;
            font-family: Consolas, Liberation Mono, Menlo, monospace, Courier;
            display: block;
            -webkit-box-sizing: border-box;
            box-sizing: border-box;
            margin-left: 16px;
            margin-right: 16px;
            overflow-x: scroll
        }

        ._29HP61GA_0 pre code:after {
            content: "";
            height: 30px;
            width: 100%;
            display: block
        }

        ._29HP61GA_0 hr {
            border: none;
            margin-top: 1.5rem;
            margin-bottom: 1.5rem;
            border-top: 1px solid #f5f5f5;
            height: 1px;
            background: none
        }

        ._29HP61GA_0 h1,
        ._29HP61GA_0 h2,
        ._29HP61GA_0 h3,
        ._29HP61GA_0 h4,
        ._29HP61GA_0 h5 {
            margin-bottom: 20px;
            margin-top: 0;
            font-weight: 700
        }

        ._29HP61GA_0 b,
        ._29HP61GA_0 strong {
            font-weight: 700
        }

        ._29HP61GA_0 h1 {
            font-size: 21px
        }

        ._29HP61GA_0 h2 {
            font-size: 20px
        }

        ._29HP61GA_0 h3 {
            font-size: 19px
        }

        ._29HP61GA_0 h4 {
            font-size: 18px
        }

        ._29HP61GA_0 h5 {
            font-size: 17px
        }

        ._29HP61GA_0 center,
        ._29HP61GA_0 p {
            font-weight: 400;
            color: #353535;
            margin-top: 0;
            margin-bottom: 30px;
            word-break: break-word
        }

        ._29HP61GA_0 center {
            text-align: center
        }

        ._29HP61GA_0 blockquote {
            margin-top: 0;
            margin-bottom: 34px;
            border-left: 3px solid #e8e8e8;
            padding-left: 17px;
            color: #353535
        }

        ._29HP61GA_0 blockquote p {
            margin-top: 0;
            margin-bottom: 0
        }

        ._29HP61GA_0 ol,
        ._29HP61GA_0 ul {
            margin-bottom: 30px
        }

        ._29HP61GA_0 ol p,
        ._29HP61GA_0 ul p {
            margin-top: 0;
            margin-bottom: 0
        }

        ._29HP61GA_0 ol {
            list-style: decimal;
            margin-left: 20px
        }

        ._29HP61GA_0 ul li {
            padding-left: 17px;
            position: relative;
            margin-bottom: 10px
        }

        ._29HP61GA_0 ul li:after {
            content: "";
            height: 6px;
            width: 6px;
            border-radius: 50%;
            background: #353535;
            position: absolute;
            top: 10px;
            left: 0
        }

        ._29HP61GA_0 .orange {
            color: #fa8919
        }

        ._29HP61GA_0 .reference {
            color: #888
        }

        ._29HP61GA_0 .m-right {
            text-align: right
        }

        ._29HP61GA_0 .m-center {
            text-align: center;
            display: block
        }

        ._29HP61GA_0 .m-gray {
            color: #888
        }

        ._29HP61GA_0 .m-small {
            font-size: 15px
        }

        ._29HP61GA_0 table.hljs-ln {
            margin-bottom: 0;
            border-spacing: 0;
            border-collapse: collapse
        }

        ._29HP61GA_0 table.hljs-ln,
        ._29HP61GA_0 table.hljs-ln tbody,
        ._29HP61GA_0 table.hljs-ln td,
        ._29HP61GA_0 table.hljs-ln tr {
            -webkit-box-sizing: border-box;
            box-sizing: border-box
        }

        ._29HP61GA_0 table.hljs-ln td {
            padding: 0;
            border: 0
        }

        ._29HP61GA_0 table.hljs-ln td.hljs-ln-numbers {
            min-width: 15px;
            font-size: 12px;
            color: rgba(27, 31, 35, .3);
            text-align: right;
            white-space: nowrap;
            cursor: pointer;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none
        }

        ._29HP61GA_0 table.hljs-ln td.hljs-ln-code,
        ._29HP61GA_0 table.hljs-ln td.hljs-ln-numbers {
            font-family: SFMono-Regular, Consolas, Liberation Mono, Menlo, Courier, monospace;
            line-height: 20px;
            vertical-align: top
        }

        ._29HP61GA_0 table.hljs-ln td.hljs-ln-code {
            position: relative;
            padding-right: 10px;
            padding-left: 10px;
            overflow: visible;
            font-size: 13px;
            color: #666;
            word-wrap: normal;
            white-space: pre
        }

    </style>
</head>
<body>
<div class="_29HP61GA_0">
<h1>05-ä¸€ä¸å°å¿ƒå°±æ­»é”äº†ï¼Œæ€ä¹ˆåŠï¼Ÿ</h1>
<p>åœ¨ä¸Šä¸€ç¯‡æ–‡ç« ä¸­ï¼Œæˆ‘ä»¬ç”¨Account.classä½œä¸ºäº’æ–¥é”ï¼Œæ¥è§£å†³é“¶è¡Œä¸šåŠ¡é‡Œé¢çš„è½¬è´¦é—®é¢˜ï¼Œè™½ç„¶è¿™ä¸ªæ–¹æ¡ˆä¸å­˜åœ¨å¹¶å‘é—®é¢˜ï¼Œä½†æ˜¯æ‰€æœ‰è´¦æˆ·çš„è½¬è´¦æ“ä½œéƒ½æ˜¯ä¸²è¡Œçš„ï¼Œä¾‹å¦‚è´¦æˆ·A è½¬è´¦æˆ·Bã€è´¦æˆ·C è½¬è´¦æˆ·Dè¿™ä¸¤ä¸ªè½¬è´¦æ“ä½œç°å®ä¸–ç•Œé‡Œæ˜¯å¯ä»¥å¹¶è¡Œçš„ï¼Œä½†æ˜¯åœ¨è¿™ä¸ªæ–¹æ¡ˆé‡Œå´è¢«ä¸²è¡ŒåŒ–äº†ï¼Œè¿™æ ·çš„è¯ï¼Œæ€§èƒ½å¤ªå·®ã€‚</p><p>è¯•æƒ³äº’è”ç½‘æ”¯ä»˜ç››è¡Œçš„å½“ä¸‹ï¼Œ8äº¿ç½‘æ°‘æ¯äººæ¯å¤©ä¸€ç¬”äº¤æ˜“ï¼Œæ¯å¤©å°±æ˜¯8äº¿ç¬”äº¤æ˜“ï¼›æ¯ç¬”äº¤æ˜“éƒ½å¯¹åº”ç€ä¸€æ¬¡è½¬è´¦æ“ä½œï¼Œ8äº¿ç¬”äº¤æ˜“å°±æ˜¯8äº¿æ¬¡è½¬è´¦æ“ä½œï¼Œä¹Ÿå°±æ˜¯è¯´å¹³å‡åˆ°æ¯ç§’å°±æ˜¯è¿‘1ä¸‡æ¬¡è½¬è´¦æ“ä½œï¼Œè‹¥æ‰€æœ‰çš„è½¬è´¦æ“ä½œéƒ½ä¸²è¡Œï¼Œæ€§èƒ½å®Œå…¨ä¸èƒ½æ¥å—ã€‚</p><p>é‚£ä¸‹é¢æˆ‘ä»¬å°±å°è¯•ç€æŠŠæ€§èƒ½æå‡ä¸€ä¸‹ã€‚</p><h2>å‘ç°å®ä¸–ç•Œè¦ç­”æ¡ˆ</h2><p>ç°å®ä¸–ç•Œé‡Œï¼Œè´¦æˆ·è½¬è´¦æ“ä½œæ˜¯æ”¯æŒå¹¶å‘çš„ï¼Œè€Œä¸”ç»å¯¹æ˜¯çœŸæ­£çš„å¹¶è¡Œï¼Œé“¶è¡Œæ‰€æœ‰çš„çª—å£éƒ½å¯ä»¥åšè½¬è´¦æ“ä½œã€‚åªè¦æˆ‘ä»¬èƒ½ä»¿ç…§ç°å®ä¸–ç•Œåšè½¬è´¦æ“ä½œï¼Œä¸²è¡Œçš„é—®é¢˜å°±è§£å†³äº†ã€‚</p><p>æˆ‘ä»¬è¯•æƒ³åœ¨å¤ä»£ï¼Œæ²¡æœ‰ä¿¡æ¯åŒ–ï¼Œè´¦æˆ·çš„å­˜åœ¨å½¢å¼çœŸçš„å°±æ˜¯ä¸€ä¸ªè´¦æœ¬ï¼Œè€Œä¸”æ¯ä¸ªè´¦æˆ·éƒ½æœ‰ä¸€ä¸ªè´¦æœ¬ï¼Œè¿™äº›è´¦æœ¬éƒ½ç»Ÿä¸€å­˜æ”¾åœ¨æ–‡ä»¶æ¶ä¸Šã€‚é“¶è¡ŒæŸœå‘˜åœ¨ç»™æˆ‘ä»¬åšè½¬è´¦æ—¶ï¼Œè¦å»æ–‡ä»¶æ¶ä¸ŠæŠŠè½¬å‡ºè´¦æœ¬å’Œè½¬å…¥è´¦æœ¬éƒ½æ‹¿åˆ°æ‰‹ï¼Œç„¶ååšè½¬è´¦ã€‚è¿™ä¸ªæŸœå‘˜åœ¨æ‹¿è´¦æœ¬çš„æ—¶å€™å¯èƒ½é‡åˆ°ä»¥ä¸‹ä¸‰ç§æƒ…å†µï¼š</p><ol>
<li>æ–‡ä»¶æ¶ä¸Šæ°å¥½æœ‰è½¬å‡ºè´¦æœ¬å’Œè½¬å…¥è´¦æœ¬ï¼Œé‚£å°±åŒæ—¶æ‹¿èµ°ï¼›</li>
<li>å¦‚æœæ–‡ä»¶æ¶ä¸Šåªæœ‰è½¬å‡ºè´¦æœ¬å’Œè½¬å…¥è´¦æœ¬ä¹‹ä¸€ï¼Œé‚£è¿™ä¸ªæŸœå‘˜å°±å…ˆæŠŠæ–‡ä»¶æ¶ä¸Šæœ‰çš„è´¦æœ¬æ‹¿åˆ°æ‰‹ï¼ŒåŒæ—¶ç­‰ç€å…¶ä»–æŸœå‘˜æŠŠå¦å¤–ä¸€ä¸ªè´¦æœ¬é€å›æ¥ï¼›</li>
<li>è½¬å‡ºè´¦æœ¬å’Œè½¬å…¥è´¦æœ¬éƒ½æ²¡æœ‰ï¼Œé‚£è¿™ä¸ªæŸœå‘˜å°±ç­‰ç€ä¸¤ä¸ªè´¦æœ¬éƒ½è¢«é€å›æ¥ã€‚</li>
</ol><!-- [[[read_end]]] --><p>ä¸Šé¢è¿™ä¸ªè¿‡ç¨‹åœ¨ç¼–ç¨‹çš„ä¸–ç•Œé‡Œæ€ä¹ˆå®ç°å‘¢ï¼Ÿå…¶å®ç”¨ä¸¤æŠŠé”å°±å®ç°äº†ï¼Œè½¬å‡ºè´¦æœ¬ä¸€æŠŠï¼Œè½¬å…¥è´¦æœ¬å¦ä¸€æŠŠã€‚åœ¨transfer()æ–¹æ³•å†…éƒ¨ï¼Œæˆ‘ä»¬é¦–å…ˆå°è¯•é”å®šè½¬å‡ºè´¦æˆ·thisï¼ˆå…ˆæŠŠè½¬å‡ºè´¦æœ¬æ‹¿åˆ°æ‰‹ï¼‰ï¼Œç„¶åå°è¯•é”å®šè½¬å…¥è´¦æˆ·targetï¼ˆå†æŠŠè½¬å…¥è´¦æœ¬æ‹¿åˆ°æ‰‹ï¼‰ï¼Œåªæœ‰å½“ä¸¤è€…éƒ½æˆåŠŸæ—¶ï¼Œæ‰æ‰§è¡Œè½¬è´¦æ“ä½œã€‚è¿™ä¸ªé€»è¾‘å¯ä»¥å›¾å½¢åŒ–ä¸ºä¸‹å›¾è¿™ä¸ªæ ·å­ã€‚</p><p><img src="https://static001.geekbang.org/resource/image/cb/55/cb18e672732ab76fc61d60bdf66bf855.png" alt=""></p><center><span class="reference">ä¸¤ä¸ªè½¬è´¦æ“ä½œå¹¶è¡Œç¤ºæ„å›¾</span></center><p>è€Œè‡³äºè¯¦ç»†çš„ä»£ç å®ç°ï¼Œå¦‚ä¸‹æ‰€ç¤ºã€‚ç»è¿‡è¿™æ ·çš„ä¼˜åŒ–åï¼Œè´¦æˆ·A è½¬è´¦æˆ·Bå’Œè´¦æˆ·C è½¬è´¦æˆ·Dè¿™ä¸¤ä¸ªè½¬è´¦æ“ä½œå°±å¯ä»¥å¹¶è¡Œäº†ã€‚</p><pre><code>class Account {
  private int balance;
  // è½¬è´¦
  void transfer(Account target, int amt){
    // é”å®šè½¬å‡ºè´¦æˆ·
    synchronized(this) {              
      // é”å®šè½¬å…¥è´¦æˆ·
      synchronized(target) {           
        if (this.balance &gt; amt) {
          this.balance -= amt;
          target.balance += amt;
        }
      }
    }
  } 
}
</code></pre><h2>æ²¡æœ‰å…è´¹çš„åˆé¤</h2><p>ä¸Šé¢çš„å®ç°çœ‹ä¸Šå»å¾ˆå®Œç¾ï¼Œå¹¶ä¸”ä¹Ÿç®—æ˜¯å°†é”ç”¨å¾—å‡ºç¥å…¥åŒ–äº†ã€‚ç›¸å¯¹äºç”¨Account.classä½œä¸ºäº’æ–¥é”ï¼Œé”å®šçš„èŒƒå›´å¤ªå¤§ï¼Œè€Œæˆ‘ä»¬é”å®šä¸¤ä¸ªè´¦æˆ·èŒƒå›´å°±å°å¤šäº†ï¼Œè¿™æ ·çš„é”ï¼Œä¸Šä¸€ç« æˆ‘ä»¬ä»‹ç»è¿‡ï¼Œå«<strong>ç»†ç²’åº¦é”</strong>ã€‚<strong>ä½¿ç”¨ç»†ç²’åº¦é”å¯ä»¥æé«˜å¹¶è¡Œåº¦ï¼Œæ˜¯æ€§èƒ½ä¼˜åŒ–çš„ä¸€ä¸ªé‡è¦æ‰‹æ®µ</strong>ã€‚</p><p>è¿™ä¸ªæ—¶å€™å¯èƒ½ä½ å·²ç»å¼€å§‹è­¦è§‰äº†ï¼Œä½¿ç”¨ç»†ç²’åº¦é”è¿™ä¹ˆç®€å•ï¼Œæœ‰è¿™æ ·çš„å¥½äº‹ï¼Œæ˜¯ä¸æ˜¯ä¹Ÿè¦ä»˜å‡ºç‚¹ä»€ä¹ˆä»£ä»·å•Šï¼Ÿç¼–å†™å¹¶å‘ç¨‹åºå°±éœ€è¦è¿™æ ·æ—¶æ—¶åˆ»åˆ»ä¿æŒè°¨æ…ã€‚</p><p><strong>çš„ç¡®ï¼Œä½¿ç”¨ç»†ç²’åº¦é”æ˜¯æœ‰ä»£ä»·çš„ï¼Œè¿™ä¸ªä»£ä»·å°±æ˜¯å¯èƒ½ä¼šå¯¼è‡´æ­»é”ã€‚</strong></p><p>åœ¨è¯¦ç»†ä»‹ç»æ­»é”ä¹‹å‰ï¼Œæˆ‘ä»¬å…ˆçœ‹çœ‹ç°å®ä¸–ç•Œé‡Œçš„ä¸€ç§ç‰¹æ®Šåœºæ™¯ã€‚å¦‚æœæœ‰å®¢æˆ·æ‰¾æŸœå‘˜å¼ ä¸‰åšä¸ªè½¬è´¦ä¸šåŠ¡ï¼šè´¦æˆ·A è½¬è´¦æˆ·B 100å…ƒï¼Œæ­¤æ—¶å¦ä¸€ä¸ªå®¢æˆ·æ‰¾æŸœå‘˜æå››ä¹Ÿåšä¸ªè½¬è´¦ä¸šåŠ¡ï¼šè´¦æˆ·B è½¬è´¦æˆ·A 100 å…ƒï¼Œäºæ˜¯å¼ ä¸‰å’Œæå››åŒæ—¶éƒ½å»æ–‡ä»¶æ¶ä¸Šæ‹¿è´¦æœ¬ï¼Œè¿™æ—¶å€™æœ‰å¯èƒ½å‡‘å·§å¼ ä¸‰æ‹¿åˆ°äº†è´¦æœ¬Aï¼Œæå››æ‹¿åˆ°äº†è´¦æœ¬Bã€‚å¼ ä¸‰æ‹¿åˆ°è´¦æœ¬Aåå°±ç­‰ç€è´¦æœ¬Bï¼ˆè´¦æœ¬Bå·²ç»è¢«æå››æ‹¿èµ°ï¼‰ï¼Œè€Œæå››æ‹¿åˆ°è´¦æœ¬Båå°±ç­‰ç€è´¦æœ¬Aï¼ˆè´¦æœ¬Aå·²ç»è¢«å¼ ä¸‰æ‹¿èµ°ï¼‰ï¼Œä»–ä»¬è¦ç­‰å¤šä¹…å‘¢ï¼Ÿä»–ä»¬ä¼šæ°¸è¿œç­‰å¾…ä¸‹å»â€¦å› ä¸ºå¼ ä¸‰ä¸ä¼šæŠŠè´¦æœ¬Aé€å›å»ï¼Œæå››ä¹Ÿä¸ä¼šæŠŠè´¦æœ¬Bé€å›å»ã€‚æˆ‘ä»¬å§‘ä¸”ç§°ä¸ºæ­»ç­‰å§ã€‚</p><p><img src="https://static001.geekbang.org/resource/image/f2/88/f293dc0d92b7c8255bd0bc790fc2a088.png" alt=""></p><center><span class="reference">è½¬è´¦ä¸šåŠ¡ä¸­çš„â€œæ­»ç­‰â€</span></center><p>ç°å®ä¸–ç•Œé‡Œçš„æ­»ç­‰ï¼Œå°±æ˜¯ç¼–ç¨‹é¢†åŸŸçš„æ­»é”äº†ã€‚<strong>æ­»é”</strong>çš„ä¸€ä¸ªæ¯”è¾ƒä¸“ä¸šçš„å®šä¹‰æ˜¯ï¼š<strong>ä¸€ç»„äº’ç›¸ç«äº‰èµ„æºçš„çº¿ç¨‹å› äº’ç›¸ç­‰å¾…ï¼Œå¯¼è‡´â€œæ°¸ä¹…â€é˜»å¡çš„ç°è±¡</strong>ã€‚</p><p>ä¸Šé¢è½¬è´¦çš„ä»£ç æ˜¯æ€ä¹ˆå‘ç”Ÿæ­»é”çš„å‘¢ï¼Ÿæˆ‘ä»¬å‡è®¾çº¿ç¨‹T1æ‰§è¡Œè´¦æˆ·Aè½¬è´¦æˆ·Bçš„æ“ä½œï¼Œè´¦æˆ·A.transfer(è´¦æˆ·B)ï¼›åŒæ—¶çº¿ç¨‹T2æ‰§è¡Œè´¦æˆ·Bè½¬è´¦æˆ·Açš„æ“ä½œï¼Œè´¦æˆ·B.transfer(è´¦æˆ·A)ã€‚å½“T1å’ŒT2åŒæ—¶æ‰§è¡Œå®Œâ‘ å¤„çš„ä»£ç æ—¶ï¼ŒT1è·å¾—äº†è´¦æˆ·Açš„é”ï¼ˆå¯¹äºT1ï¼Œthisæ˜¯è´¦æˆ·Aï¼‰ï¼Œè€ŒT2è·å¾—äº†è´¦æˆ·Bçš„é”ï¼ˆå¯¹äºT2ï¼Œthisæ˜¯è´¦æˆ·Bï¼‰ã€‚ä¹‹åT1å’ŒT2åœ¨æ‰§è¡Œâ‘¡å¤„çš„ä»£ç æ—¶ï¼ŒT1è¯•å›¾è·å–è´¦æˆ·Bçš„é”æ—¶ï¼Œå‘ç°è´¦æˆ·Bå·²ç»è¢«é”å®šï¼ˆè¢«T2é”å®šï¼‰ï¼Œæ‰€ä»¥T1å¼€å§‹ç­‰å¾…ï¼›T2åˆ™è¯•å›¾è·å–è´¦æˆ·Açš„é”æ—¶ï¼Œå‘ç°è´¦æˆ·Aå·²ç»è¢«é”å®šï¼ˆè¢«T1é”å®šï¼‰ï¼Œæ‰€ä»¥T2ä¹Ÿå¼€å§‹ç­‰å¾…ã€‚äºæ˜¯T1å’ŒT2ä¼šæ— æœŸé™åœ°ç­‰å¾…ä¸‹å»ï¼Œä¹Ÿå°±æ˜¯æˆ‘ä»¬æ‰€è¯´çš„æ­»é”äº†ã€‚</p><pre><code>class Account {
  private int balance;
  // è½¬è´¦
  void transfer(Account target, int amt){
    // é”å®šè½¬å‡ºè´¦æˆ·
    synchronized(this){     â‘ 
      // é”å®šè½¬å…¥è´¦æˆ·
      synchronized(target){ â‘¡
        if (this.balance &gt; amt) {
          this.balance -= amt;
          target.balance += amt;
        }
      }
    }
  } 
}
</code></pre><p>å…³äºè¿™ç§ç°è±¡ï¼Œæˆ‘ä»¬è¿˜å¯ä»¥å€ŸåŠ©èµ„æºåˆ†é…å›¾æ¥å¯è§†åŒ–é”çš„å ç”¨æƒ…å†µï¼ˆèµ„æºåˆ†é…å›¾æ˜¯ä¸ªæœ‰å‘å›¾ï¼Œå®ƒå¯ä»¥æè¿°èµ„æºå’Œçº¿ç¨‹çš„çŠ¶æ€ï¼‰ã€‚å…¶ä¸­ï¼Œèµ„æºç”¨æ–¹å½¢èŠ‚ç‚¹è¡¨ç¤ºï¼Œçº¿ç¨‹ç”¨åœ†å½¢èŠ‚ç‚¹è¡¨ç¤ºï¼›èµ„æºä¸­çš„ç‚¹æŒ‡å‘çº¿ç¨‹çš„è¾¹è¡¨ç¤ºçº¿ç¨‹å·²ç»è·å¾—è¯¥èµ„æºï¼Œçº¿ç¨‹æŒ‡å‘èµ„æºçš„è¾¹åˆ™è¡¨ç¤ºçº¿ç¨‹è¯·æ±‚èµ„æºï¼Œä½†å°šæœªå¾—åˆ°ã€‚è½¬è´¦å‘ç”Ÿæ­»é”æ—¶çš„èµ„æºåˆ†é…å›¾å°±å¦‚ä¸‹å›¾æ‰€ç¤ºï¼Œä¸€ä¸ªâ€œå„æ®å±±å¤´æ­»ç­‰â€çš„å°´å°¬å±€é¢ã€‚</p><p><img src="https://static001.geekbang.org/resource/image/82/1c/829d69c7d32c3ad1b89d89fc56017d1c.png" alt=""></p><center><span class="reference">è½¬è´¦å‘ç”Ÿæ­»é”æ—¶çš„èµ„æºåˆ†é…å›¾</span></center><h2>å¦‚ä½•é¢„é˜²æ­»é”</h2><p>å¹¶å‘ç¨‹åºä¸€æ—¦æ­»é”ï¼Œä¸€èˆ¬æ²¡æœ‰ç‰¹åˆ«å¥½çš„æ–¹æ³•ï¼Œå¾ˆå¤šæ—¶å€™æˆ‘ä»¬åªèƒ½é‡å¯åº”ç”¨ã€‚å› æ­¤ï¼Œè§£å†³æ­»é”é—®é¢˜æœ€å¥½çš„åŠæ³•è¿˜æ˜¯è§„é¿æ­»é”ã€‚</p><p>é‚£å¦‚ä½•é¿å…æ­»é”å‘¢ï¼Ÿè¦é¿å…æ­»é”å°±éœ€è¦åˆ†ææ­»é”å‘ç”Ÿçš„æ¡ä»¶ï¼Œæœ‰ä¸ªå«Coffmançš„ç‰›äººæ—©å°±æ€»ç»“è¿‡äº†ï¼Œåªæœ‰ä»¥ä¸‹è¿™å››ä¸ªæ¡ä»¶éƒ½å‘ç”Ÿæ—¶æ‰ä¼šå‡ºç°æ­»é”ï¼š</p><blockquote></blockquote><ol>
<li>äº’æ–¥ï¼Œå…±äº«èµ„æºXå’ŒYåªèƒ½è¢«ä¸€ä¸ªçº¿ç¨‹å ç”¨ï¼›</li>
<li>å æœ‰ä¸”ç­‰å¾…ï¼Œçº¿ç¨‹T1å·²ç»å–å¾—å…±äº«èµ„æºXï¼Œåœ¨ç­‰å¾…å…±äº«èµ„æºYçš„æ—¶å€™ï¼Œä¸é‡Šæ”¾å…±äº«èµ„æºXï¼›</li>
<li>ä¸å¯æŠ¢å ï¼Œå…¶ä»–çº¿ç¨‹ä¸èƒ½å¼ºè¡ŒæŠ¢å çº¿ç¨‹T1å æœ‰çš„èµ„æºï¼›</li>
<li>å¾ªç¯ç­‰å¾…ï¼Œçº¿ç¨‹T1ç­‰å¾…çº¿ç¨‹T2å æœ‰çš„èµ„æºï¼Œçº¿ç¨‹T2ç­‰å¾…çº¿ç¨‹T1å æœ‰çš„èµ„æºï¼Œå°±æ˜¯å¾ªç¯ç­‰å¾…ã€‚</li>
</ol><p>åè¿‡æ¥åˆ†æï¼Œ<strong>ä¹Ÿå°±æ˜¯è¯´åªè¦æˆ‘ä»¬ç ´åå…¶ä¸­ä¸€ä¸ªï¼Œå°±å¯ä»¥æˆåŠŸé¿å…æ­»é”çš„å‘ç”Ÿ</strong>ã€‚</p><p>å…¶ä¸­ï¼Œäº’æ–¥è¿™ä¸ªæ¡ä»¶æˆ‘ä»¬æ²¡æœ‰åŠæ³•ç ´åï¼Œå› ä¸ºæˆ‘ä»¬ç”¨é”ä¸ºçš„å°±æ˜¯äº’æ–¥ã€‚ä¸è¿‡å…¶ä»–ä¸‰ä¸ªæ¡ä»¶éƒ½æ˜¯æœ‰åŠæ³•ç ´åæ‰çš„ï¼Œåˆ°åº•å¦‚ä½•åšå‘¢ï¼Ÿ</p><ol>
<li>å¯¹äºâ€œå ç”¨ä¸”ç­‰å¾…â€è¿™ä¸ªæ¡ä»¶ï¼Œæˆ‘ä»¬å¯ä»¥ä¸€æ¬¡æ€§ç”³è¯·æ‰€æœ‰çš„èµ„æºï¼Œè¿™æ ·å°±ä¸å­˜åœ¨ç­‰å¾…äº†ã€‚</li>
<li>å¯¹äºâ€œä¸å¯æŠ¢å â€è¿™ä¸ªæ¡ä»¶ï¼Œå ç”¨éƒ¨åˆ†èµ„æºçš„çº¿ç¨‹è¿›ä¸€æ­¥ç”³è¯·å…¶ä»–èµ„æºæ—¶ï¼Œå¦‚æœç”³è¯·ä¸åˆ°ï¼Œå¯ä»¥ä¸»åŠ¨é‡Šæ”¾å®ƒå æœ‰çš„èµ„æºï¼Œè¿™æ ·ä¸å¯æŠ¢å è¿™ä¸ªæ¡ä»¶å°±ç ´åæ‰äº†ã€‚</li>
<li>å¯¹äºâ€œå¾ªç¯ç­‰å¾…â€è¿™ä¸ªæ¡ä»¶ï¼Œå¯ä»¥é æŒ‰åºç”³è¯·èµ„æºæ¥é¢„é˜²ã€‚æ‰€è°“æŒ‰åºç”³è¯·ï¼Œæ˜¯æŒ‡èµ„æºæ˜¯æœ‰çº¿æ€§é¡ºåºçš„ï¼Œç”³è¯·çš„æ—¶å€™å¯ä»¥å…ˆç”³è¯·èµ„æºåºå·å°çš„ï¼Œå†ç”³è¯·èµ„æºåºå·å¤§çš„ï¼Œè¿™æ ·çº¿æ€§åŒ–åè‡ªç„¶å°±ä¸å­˜åœ¨å¾ªç¯äº†ã€‚</li>
</ol><p>æˆ‘ä»¬å·²ç»ä»ç†è®ºä¸Šè§£å†³äº†å¦‚ä½•é¢„é˜²æ­»é”ï¼Œé‚£å…·ä½“å¦‚ä½•ä½“ç°åœ¨ä»£ç ä¸Šå‘¢ï¼Ÿä¸‹é¢æˆ‘ä»¬å°±æ¥å°è¯•ç”¨ä»£ç å®è·µä¸€ä¸‹è¿™äº›ç†è®ºã€‚</p><h3>1. ç ´åå ç”¨ä¸”ç­‰å¾…æ¡ä»¶</h3><p>ä»ç†è®ºä¸Šè®²ï¼Œè¦ç ´åè¿™ä¸ªæ¡ä»¶ï¼Œå¯ä»¥ä¸€æ¬¡æ€§ç”³è¯·æ‰€æœ‰èµ„æºã€‚åœ¨ç°å®ä¸–ç•Œé‡Œï¼Œå°±æ‹¿å‰é¢æˆ‘ä»¬æåˆ°çš„è½¬è´¦æ“ä½œæ¥è®²ï¼Œå®ƒéœ€è¦çš„èµ„æºæœ‰ä¸¤ä¸ªï¼Œä¸€ä¸ªæ˜¯è½¬å‡ºè´¦æˆ·ï¼Œå¦ä¸€ä¸ªæ˜¯è½¬å…¥è´¦æˆ·ï¼Œå½“è¿™ä¸¤ä¸ªè´¦æˆ·åŒæ—¶è¢«ç”³è¯·æ—¶ï¼Œæˆ‘ä»¬è¯¥æ€ä¹ˆè§£å†³è¿™ä¸ªé—®é¢˜å‘¢ï¼Ÿ</p><p>å¯ä»¥å¢åŠ ä¸€ä¸ªè´¦æœ¬ç®¡ç†å‘˜ï¼Œç„¶ååªå…è®¸è´¦æœ¬ç®¡ç†å‘˜ä»æ–‡ä»¶æ¶ä¸Šæ‹¿è´¦æœ¬ï¼Œä¹Ÿå°±æ˜¯è¯´æŸœå‘˜ä¸èƒ½ç›´æ¥åœ¨æ–‡ä»¶æ¶ä¸Šæ‹¿è´¦æœ¬ï¼Œå¿…é¡»é€šè¿‡è´¦æœ¬ç®¡ç†å‘˜æ‰èƒ½æ‹¿åˆ°æƒ³è¦çš„è´¦æœ¬ã€‚ä¾‹å¦‚ï¼Œå¼ ä¸‰åŒæ—¶ç”³è¯·è´¦æœ¬Aå’ŒBï¼Œè´¦æœ¬ç®¡ç†å‘˜å¦‚æœå‘ç°æ–‡ä»¶æ¶ä¸Šåªæœ‰è´¦æœ¬Aï¼Œè¿™ä¸ªæ—¶å€™è´¦æœ¬ç®¡ç†å‘˜æ˜¯ä¸ä¼šæŠŠè´¦æœ¬Aæ‹¿ä¸‹æ¥ç»™å¼ ä¸‰çš„ï¼Œåªæœ‰è´¦æœ¬Aå’ŒBéƒ½åœ¨çš„æ—¶å€™æ‰ä¼šç»™å¼ ä¸‰ã€‚è¿™æ ·å°±ä¿è¯äº†â€œä¸€æ¬¡æ€§ç”³è¯·æ‰€æœ‰èµ„æºâ€ã€‚</p><p><img src="https://static001.geekbang.org/resource/image/27/db/273af8c2ee60bd659f18673d2af005db.png" alt=""></p><center><span class="reference">é€šè¿‡è´¦æœ¬ç®¡ç†å‘˜æ‹¿è´¦æœ¬</span></center><p>å¯¹åº”åˆ°ç¼–ç¨‹é¢†åŸŸï¼Œâ€œåŒæ—¶ç”³è¯·â€è¿™ä¸ªæ“ä½œæ˜¯ä¸€ä¸ªä¸´ç•ŒåŒºï¼Œæˆ‘ä»¬ä¹Ÿéœ€è¦ä¸€ä¸ªè§’è‰²ï¼ˆJavaé‡Œé¢çš„ç±»ï¼‰æ¥ç®¡ç†è¿™ä¸ªä¸´ç•ŒåŒºï¼Œæˆ‘ä»¬å°±æŠŠè¿™ä¸ªè§’è‰²å®šä¸ºAllocatorã€‚å®ƒæœ‰ä¸¤ä¸ªé‡è¦åŠŸèƒ½ï¼Œåˆ†åˆ«æ˜¯ï¼šåŒæ—¶ç”³è¯·èµ„æºapply()å’ŒåŒæ—¶é‡Šæ”¾èµ„æºfree()ã€‚è´¦æˆ·Account ç±»é‡Œé¢æŒæœ‰ä¸€ä¸ªAllocatorçš„å•ä¾‹ï¼ˆå¿…é¡»æ˜¯å•ä¾‹ï¼Œåªèƒ½ç”±ä¸€ä¸ªäººæ¥åˆ†é…èµ„æºï¼‰ã€‚å½“è´¦æˆ·Accountåœ¨æ‰§è¡Œè½¬è´¦æ“ä½œçš„æ—¶å€™ï¼Œé¦–å…ˆå‘AllocatoråŒæ—¶ç”³è¯·è½¬å‡ºè´¦æˆ·å’Œè½¬å…¥è´¦æˆ·è¿™ä¸¤ä¸ªèµ„æºï¼ŒæˆåŠŸåå†é”å®šè¿™ä¸¤ä¸ªèµ„æºï¼›å½“è½¬è´¦æ“ä½œæ‰§è¡Œå®Œï¼Œé‡Šæ”¾é”ä¹‹åï¼Œæˆ‘ä»¬éœ€é€šçŸ¥AllocatoråŒæ—¶é‡Šæ”¾è½¬å‡ºè´¦æˆ·å’Œè½¬å…¥è´¦æˆ·è¿™ä¸¤ä¸ªèµ„æºã€‚å…·ä½“çš„ä»£ç å®ç°å¦‚ä¸‹ã€‚</p><pre><code>class Allocator {
  private List&lt;Object&gt; als =
    new ArrayList&lt;&gt;();
  // ä¸€æ¬¡æ€§ç”³è¯·æ‰€æœ‰èµ„æº
  synchronized boolean apply(
    Object from, Object to){
    if(als.contains(from) ||
         als.contains(to)){
      return false;  
    } else {
      als.add(from);
      als.add(to);  
    }
    return true;
  }
  // å½’è¿˜èµ„æº
  synchronized void free(
    Object from, Object to){
    als.remove(from);
    als.remove(to);
  }
}

class Account {
  // actråº”è¯¥ä¸ºå•ä¾‹
  private Allocator actr;
  private int balance;
  // è½¬è´¦
  void transfer(Account target, int amt){
    // ä¸€æ¬¡æ€§ç”³è¯·è½¬å‡ºè´¦æˆ·å’Œè½¬å…¥è´¦æˆ·ï¼Œç›´åˆ°æˆåŠŸ
    while(!actr.apply(this, target))
      ï¼›
    try{
      // é”å®šè½¬å‡ºè´¦æˆ·
      synchronized(this){              
        // é”å®šè½¬å…¥è´¦æˆ·
        synchronized(target){           
          if (this.balance &gt; amt){
            this.balance -= amt;
            target.balance += amt;
          }
        }
      }
    } finally {
      actr.free(this, target)
    }
  } 
}
</code></pre><h3>2. ç ´åä¸å¯æŠ¢å æ¡ä»¶</h3><p>ç ´åä¸å¯æŠ¢å æ¡ä»¶çœ‹ä¸Šå»å¾ˆç®€å•ï¼Œæ ¸å¿ƒæ˜¯è¦èƒ½å¤Ÿä¸»åŠ¨é‡Šæ”¾å®ƒå æœ‰çš„èµ„æºï¼Œè¿™ä¸€ç‚¹synchronizedæ˜¯åšä¸åˆ°çš„ã€‚åŸå› æ˜¯synchronizedç”³è¯·èµ„æºçš„æ—¶å€™ï¼Œå¦‚æœç”³è¯·ä¸åˆ°ï¼Œçº¿ç¨‹ç›´æ¥è¿›å…¥é˜»å¡çŠ¶æ€äº†ï¼Œè€Œçº¿ç¨‹è¿›å…¥é˜»å¡çŠ¶æ€ï¼Œå•¥éƒ½å¹²ä¸äº†ï¼Œä¹Ÿé‡Šæ”¾ä¸äº†çº¿ç¨‹å·²ç»å æœ‰çš„èµ„æºã€‚</p><p>ä½ å¯èƒ½ä¼šè´¨ç–‘ï¼Œâ€œJavaä½œä¸ºæ’è¡Œæ¦œç¬¬ä¸€çš„è¯­è¨€ï¼Œè¿™éƒ½è§£å†³ä¸äº†ï¼Ÿâ€ä½ çš„æ€€ç–‘å¾ˆæœ‰é“ç†ï¼ŒJavaåœ¨è¯­è¨€å±‚æ¬¡ç¡®å®æ²¡æœ‰è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œä¸è¿‡åœ¨SDKå±‚é¢è¿˜æ˜¯è§£å†³äº†çš„ï¼Œjava.util.concurrentè¿™ä¸ªåŒ…ä¸‹é¢æä¾›çš„Lockæ˜¯å¯ä»¥è½»æ¾è§£å†³è¿™ä¸ªé—®é¢˜çš„ã€‚å…³äºè¿™ä¸ªè¯é¢˜ï¼Œå’±ä»¬åé¢ä¼šè¯¦ç»†è®²ã€‚</p><h3>3. ç ´åå¾ªç¯ç­‰å¾…æ¡ä»¶</h3><p>ç ´åè¿™ä¸ªæ¡ä»¶ï¼Œéœ€è¦å¯¹èµ„æºè¿›è¡Œæ’åºï¼Œç„¶åæŒ‰åºç”³è¯·èµ„æºã€‚è¿™ä¸ªå®ç°éå¸¸ç®€å•ï¼Œæˆ‘ä»¬å‡è®¾æ¯ä¸ªè´¦æˆ·éƒ½æœ‰ä¸åŒçš„å±æ€§ idï¼Œè¿™ä¸ª id å¯ä»¥ä½œä¸ºæ’åºå­—æ®µï¼Œç”³è¯·çš„æ—¶å€™ï¼Œæˆ‘ä»¬å¯ä»¥æŒ‰ç…§ä»å°åˆ°å¤§çš„é¡ºåºæ¥ç”³è¯·ã€‚æ¯”å¦‚ä¸‹é¢ä»£ç ä¸­ï¼Œâ‘ ~â‘¥å¤„çš„ä»£ç å¯¹è½¬å‡ºè´¦æˆ·ï¼ˆthisï¼‰å’Œè½¬å…¥è´¦æˆ·ï¼ˆtargetï¼‰æ’åºï¼Œç„¶åæŒ‰ç…§åºå·ä»å°åˆ°å¤§çš„é¡ºåºé”å®šè´¦æˆ·ã€‚è¿™æ ·å°±ä¸å­˜åœ¨â€œå¾ªç¯â€ç­‰å¾…äº†ã€‚</p><pre><code>class Account {
  private int id;
  private int balance;
  // è½¬è´¦
  void transfer(Account target, int amt){
    Account left = this        â‘ 
    Account right = target;    â‘¡
    if (this.id &gt; target.id) { â‘¢
      left = target;           â‘£
      right = this;            â‘¤
    }                          â‘¥
    // é”å®šåºå·å°çš„è´¦æˆ·
    synchronized(left){
      // é”å®šåºå·å¤§çš„è´¦æˆ·
      synchronized(right){ 
        if (this.balance &gt; amt){
          this.balance -= amt;
          target.balance += amt;
        }
      }
    }
  } 
}
</code></pre><h2>æ€»ç»“</h2><p>å½“æˆ‘ä»¬åœ¨ç¼–ç¨‹ä¸–ç•Œé‡Œé‡åˆ°é—®é¢˜æ—¶ï¼Œåº”ä¸å±€é™äºå½“ä¸‹ï¼Œå¯ä»¥æ¢ä¸ªæ€è·¯ï¼Œå‘ç°å®ä¸–ç•Œè¦ç­”æ¡ˆï¼Œ<strong>åˆ©ç”¨ç°å®ä¸–ç•Œçš„æ¨¡å‹æ¥æ„æ€è§£å†³æ–¹æ¡ˆ</strong>ï¼Œè¿™æ ·å¾€å¾€èƒ½å¤Ÿè®©æˆ‘ä»¬çš„æ–¹æ¡ˆæ›´å®¹æ˜“ç†è§£ï¼Œä¹Ÿæ›´èƒ½å¤Ÿçœ‹æ¸…æ¥šé—®é¢˜çš„æœ¬è´¨ã€‚</p><p>ä½†æ˜¯ç°å®ä¸–ç•Œçš„æ¨¡å‹æœ‰äº›ç»†èŠ‚å¾€å¾€ä¼šè¢«æˆ‘ä»¬å¿½è§†ã€‚å› ä¸ºåœ¨ç°å®ä¸–ç•Œé‡Œï¼Œäººå¤ªæ™ºèƒ½äº†ï¼Œä»¥è‡´æœ‰äº›ç»†èŠ‚å®åœ¨æ˜¯æ˜¾å¾—å¤ªä¸é‡è¦äº†ã€‚åœ¨è½¬è´¦çš„æ¨¡å‹ä¸­ï¼Œæˆ‘ä»¬ä¸ºä»€ä¹ˆä¼šå¿½è§†æ­»é”é—®é¢˜å‘¢ï¼ŸåŸå› ä¸»è¦æ˜¯åœ¨ç°å®ä¸–ç•Œï¼Œæˆ‘ä»¬ä¼šäº¤æµï¼Œå¹¶ä¸”ä¼šå¾ˆæ™ºèƒ½åœ°äº¤æµã€‚è€Œç¼–ç¨‹ä¸–ç•Œé‡Œï¼Œä¸¤ä¸ªçº¿ç¨‹æ˜¯ä¸ä¼šæ™ºèƒ½åœ°äº¤æµçš„ã€‚æ‰€ä»¥åœ¨åˆ©ç”¨ç°å®æ¨¡å‹å»ºæ¨¡çš„æ—¶å€™ï¼Œæˆ‘ä»¬è¿˜è¦ä»”ç»†å¯¹æ¯”ç°å®ä¸–ç•Œå’Œç¼–ç¨‹ä¸–ç•Œé‡Œçš„å„è§’è‰²ä¹‹é—´çš„å·®å¼‚ã€‚</p><p>æˆ‘ä»¬ä»Šå¤©è¿™ä¸€ç¯‡æ–‡ç« ä¸»è¦è®²äº†<strong>ç”¨ç»†ç²’åº¦é”æ¥é”å®šå¤šä¸ªèµ„æºæ—¶ï¼Œè¦æ³¨æ„æ­»é”çš„é—®é¢˜</strong>ã€‚è¿™ä¸ªå°±éœ€è¦ä½ èƒ½æŠŠå®ƒå¼ºåŒ–ä¸ºä¸€ä¸ªæ€ç»´å®šåŠ¿ï¼Œé‡åˆ°è¿™ç§åœºæ™¯ï¼Œé©¬ä¸Šæƒ³åˆ°å¯èƒ½å­˜åœ¨æ­»é”é—®é¢˜ã€‚å½“ä½ çŸ¥é“é£é™©ä¹‹åï¼Œæ‰æœ‰æœºä¼šè°ˆå¦‚ä½•é¢„é˜²å’Œé¿å…ï¼Œå› æ­¤ï¼Œ<strong>è¯†åˆ«å‡ºé£é™©å¾ˆé‡è¦</strong>ã€‚</p><p>é¢„é˜²æ­»é”ä¸»è¦æ˜¯ç ´åä¸‰ä¸ªæ¡ä»¶ä¸­çš„ä¸€ä¸ªï¼Œæœ‰äº†è¿™ä¸ªæ€è·¯åï¼Œå®ç°å°±ç®€å•äº†ã€‚ä½†ä»éœ€æ³¨æ„çš„æ˜¯ï¼Œæœ‰æ—¶å€™é¢„é˜²æ­»é”æˆæœ¬ä¹Ÿæ˜¯å¾ˆé«˜çš„ã€‚ä¾‹å¦‚ä¸Šé¢è½¬è´¦é‚£ä¸ªä¾‹å­ï¼Œæˆ‘ä»¬ç ´åå ç”¨ä¸”ç­‰å¾…æ¡ä»¶çš„æˆæœ¬å°±æ¯”ç ´åå¾ªç¯ç­‰å¾…æ¡ä»¶çš„æˆæœ¬é«˜ï¼Œç ´åå ç”¨ä¸”ç­‰å¾…æ¡ä»¶ï¼Œæˆ‘ä»¬ä¹Ÿæ˜¯é”äº†æ‰€æœ‰çš„è´¦æˆ·ï¼Œè€Œä¸”è¿˜æ˜¯ç”¨äº†æ­»å¾ªç¯ <code>while(!actr.apply(this, target));</code>æ–¹æ³•ï¼Œä¸è¿‡å¥½åœ¨apply()è¿™ä¸ªæ–¹æ³•åŸºæœ¬ä¸è€—æ—¶ã€‚ åœ¨è½¬è´¦è¿™ä¸ªä¾‹å­ä¸­ï¼Œç ´åå¾ªç¯ç­‰å¾…æ¡ä»¶å°±æ˜¯æˆæœ¬æœ€ä½çš„ä¸€ä¸ªæ–¹æ¡ˆã€‚</p><p>æ‰€ä»¥æˆ‘ä»¬åœ¨é€‰æ‹©å…·ä½“æ–¹æ¡ˆçš„æ—¶å€™ï¼Œè¿˜éœ€è¦<strong>è¯„ä¼°ä¸€ä¸‹æ“ä½œæˆæœ¬ï¼Œä»ä¸­é€‰æ‹©ä¸€ä¸ªæˆæœ¬æœ€ä½çš„æ–¹æ¡ˆ</strong>ã€‚</p><h2>è¯¾åæ€è€ƒ</h2><p>æˆ‘ä»¬ä¸Šé¢æåˆ°ï¼šç ´åå ç”¨ä¸”ç­‰å¾…æ¡ä»¶ï¼Œæˆ‘ä»¬ä¹Ÿæ˜¯é”äº†æ‰€æœ‰çš„è´¦æˆ·ï¼Œè€Œä¸”è¿˜æ˜¯ç”¨äº†æ­»å¾ªç¯ <code>while(!actr.apply(this, target));</code>è¿™ä¸ªæ–¹æ³•ï¼Œé‚£å®ƒæ¯”synchronized(Account.class)æœ‰æ²¡æœ‰æ€§èƒ½ä¼˜åŠ¿å‘¢ï¼Ÿ</p><p>æ¬¢è¿åœ¨ç•™è¨€åŒºä¸æˆ‘åˆ†äº«ä½ çš„æƒ³æ³•ï¼Œä¹Ÿæ¬¢è¿ä½ åœ¨ç•™è¨€åŒºè®°å½•ä½ çš„æ€è€ƒè¿‡ç¨‹ã€‚æ„Ÿè°¢é˜…è¯»ï¼Œå¦‚æœä½ è§‰å¾—è¿™ç¯‡æ–‡ç« å¯¹ä½ æœ‰å¸®åŠ©çš„è¯ï¼Œä¹Ÿæ¬¢è¿æŠŠå®ƒåˆ†äº«ç»™æ›´å¤šçš„æœ‹å‹ã€‚</p><h1>çŒœä½ å–œæ¬¢</h1><p><a href="https://time.geekbang.org/course/intro/156?utm_term=zeusRVDGT&amp;utm_source=app&amp;utm_medium=javabingfabiancheng&amp;utm_campaign=156-onsell&amp;utm_content=banner0301"><img src="https://static001.geekbang.org/resource/image/8e/93/8e1906fb8a24d5eb66539fa88ea56193.png" alt="unpreview"></a></p><h2>ç²¾é€‰ç•™è¨€ï¼š</h2>
        <ul>
        
<li>
    <div>
        <div style="color: #888;font-size:15.25px;font-weight:400;line-height:1.2">
            æé±¼çš„æ¬ç –å¥‡  2019-03-09 01:18:37
        </div>
        <div style="color:#353535;font-weight:400;white-space:normal;word-break:break-all;line-height:1.6">
            synchronized(Account.class) é”äº†Accountç±»ç›¸å…³çš„æ‰€æœ‰æ“ä½œã€‚ç›¸å½“äºæ–‡ä¸­è¯´çš„åŒ…åœºäº†ï¼Œåªè¦ä¸Accountæœ‰å…³è”ï¼Œé€šé€šéœ€è¦ç­‰å¾…å½“å‰çº¿ç¨‹æ“ä½œå®Œæˆã€‚whileæ­»å¾ªç¯çš„æ–¹å¼åªé”å®šäº†å½“å‰æ“ä½œçš„ä¸¤ä¸ªç›¸å…³çš„å¯¹è±¡ã€‚ä¸¤ç§å½±å“åˆ°çš„èŒƒå›´ä¸åŒã€‚ [18èµ]
        </div>
        <br/>
<div>
    <div style="color:#888;font-size:15.25px;font-weight:400;line-height:1.2">ä½œè€…å›å¤2019-03-09 08:36:44</div>
    <div style="color:#353535;font-weight:400;white-space:normal;word-break:break-all;line-height:1.6">è¿˜çœŸæ˜¯è¿™æ ·å•Šï¼<br></div>
</div>
            
    </div>
</li>
            
<br/>

<li>
    <div>
        <div style="color: #888;font-size:15.25px;font-weight:400;line-height:1.2">
            Tony Du  2019-03-09 11:27:38
        </div>
        <div style="color:#353535;font-weight:400;white-space:normal;word-break:break-all;line-height:1.6">
            whileå¾ªç¯æ˜¯ä¸æ˜¯åº”è¯¥æœ‰ä¸ªtimeoutï¼Œé¿å…ä¸€ç›´é˜»å¡ä¸‹å»ï¼Ÿ [15èµ]
        </div>
        <br/>
<div>
    <div style="color:#888;font-size:15.25px;font-weight:400;line-height:1.2">ä½œè€…å›å¤2019-03-09 14:00:03</div>
    <div style="color:#353535;font-weight:400;white-space:normal;word-break:break-all;line-height:1.6">ä½ è€ƒè™‘çš„å¾ˆå‘¨åˆ°ï¼ğŸ‘<br>åŠ è¶…æ—¶åœ¨å®é™…é¡¹ç›®ä¸­éå¸¸é‡è¦ï¼</div>
</div>
            
    </div>
</li>
            
<br/>

<li>
    <div>
        <div style="color: #888;font-size:15.25px;font-weight:400;line-height:1.2">
            DemonLee  2019-03-09 12:08:04
        </div>
        <div style="color:#353535;font-weight:400;white-space:normal;word-break:break-all;line-height:1.6">
            while(actr.apply(this, target)); --&gt; while(!actr.apply(this, target));<br>æˆ‘æ„Ÿè§‰åº”è¯¥æ˜¯è¿™æ ·ï¼Œè€å¸ˆï¼Œæˆ‘ç†è§£é”™äº†ï¼Ÿ [11èµ]
        </div>
        <br/>
<div>
    <div style="color:#888;font-size:15.25px;font-weight:400;line-height:1.2">ä½œè€…å›å¤2019-03-09 12:58:21</div>
    <div style="color:#353535;font-weight:400;white-space:normal;word-break:break-all;line-height:1.6">ä½ å‘ç°äº†ä¸ªå¤§bug!æ„Ÿè°¢æ„Ÿè°¢ï¼ï¼ï¼æˆ‘è¿™å°±ä¿®æ”¹ä¸€ä¸‹å•Š<br></div>
</div>
            
    </div>
</li>
            
<br/>

<li>
    <div>
        <div style="color: #888;font-size:15.25px;font-weight:400;line-height:1.2">
            é‚‹é¢çš„æµæµªå‰‘å®¢  2019-03-09 09:14:28
        </div>
        <div style="color:#353535;font-weight:400;white-space:normal;word-break:break-all;line-height:1.6">
            æ€è€ƒé¢˜çš„è¯å¸Œæœ›è€å¸ˆèƒ½å¤Ÿè¿‡åç»™å‡ºä¸€ä¸ªæ¯”è¾ƒæ ‡å‡†çš„ç­”æ¡ˆï¼Œæ¯•ç«Ÿå¤§å®¶çš„ç•™è¨€ä¸­è¯´æ³•å„ä¸ç›¸åŒå¾ˆéš¾å»åˆ¤æ–­ç­”æ¡ˆçš„å¯¹é”™ [9èµ]
        </div>
        <br/>
<div>
    <div style="color:#888;font-size:15.25px;font-weight:400;line-height:1.2">ä½œè€…å›å¤2019-03-09 10:21:31</div>
    <div style="color:#353535;font-weight:400;white-space:normal;word-break:break-all;line-height:1.6">è¿™ä¸€éƒ¨åˆ†çš„æœ€åä¸€ç« ï¼Œè¦ä¸å°±ç»™ç­”æ¡ˆå§<br></div>
</div>
            
    </div>
</li>
            
<br/>

<li>
    <div>
        <div style="color: #888;font-size:15.25px;font-weight:400;line-height:1.2">
            Howie  2019-03-09 17:19:32
        </div>
        <div style="color:#353535;font-weight:400;white-space:normal;word-break:break-all;line-height:1.6">
            while å¾ªç¯å°±æ˜¯ä¸€ä¸ªè‡ªæ—‹é”æœºåˆ¶å§ï¼Œè‡ªæ—‹é”çš„è¯è¦å…³æ³¨å®ƒçš„å¾ªç¯æ—¶é—´ï¼Œä¸èƒ½ä¸€ç›´å¾ªç¯ä¸‹å»ï¼Œä¸ç„¶ä¼šæµªè´¹ cpu èµ„æºã€‚ [6èµ]
        </div>
        <br/>
<div>
    <div style="color:#888;font-size:15.25px;font-weight:400;line-height:1.2">ä½œè€…å›å¤2019-03-09 21:28:27</div>
    <div style="color:#353535;font-weight:400;white-space:normal;word-break:break-all;line-height:1.6">è‡ªæ—‹é”åœ¨JVMé‡Œæ˜¯ä¸€ç§ç‰¹æ®Šçš„é”æœºåˆ¶ï¼Œè‡ªè¯©ä¸ä¼šé˜»å¡çº¿ç¨‹çš„ã€‚å’±ä»¬è¿™ä¸ªå…¶å®è¿˜æ˜¯ä¼šé˜»å¡çº¿ç¨‹çš„ã€‚ä¸è¿‡åŸç†éƒ½ä¸€æ ·ï¼Œä½ è¿™æ ·ç†è§£ä¹Ÿæ²¡é—®é¢˜ã€‚</div>
</div>
            
    </div>
</li>
            
<br/>

<li>
    <div>
        <div style="color: #888;font-size:15.25px;font-weight:400;line-height:1.2">
            åˆ«çš±çœ‰  2019-03-14 11:00:39
        </div>
        <div style="color:#353535;font-weight:400;white-space:normal;word-break:break-all;line-height:1.6">
            @é˜¿å®˜ æˆ‘æ¥å›ç­”ä¸‹ä½ çš„é—®é¢˜<br><br>ä»¥ä¸‹æ˜¯é˜¿å®˜çš„é—®é¢˜<br>-------------------------------------------------------<br>è€å¸ˆï¼Œåœ¨ç ´åå ç”¨ä¸”ç­‰å¾…çš„æ¡ˆä¾‹ä¸­ï¼Œä¸ºä½•ç”³è¯·å®Œä¸¤ä¸ªè´¦æˆ·çš„èµ„æºåè¿˜éœ€è¦å†åˆ†åˆ«é”å®šthiså’Œtargetè´¦æˆ·å‘¢ï¼Ÿ<br>-------------------------------------------------------<br>å› ä¸ºè¿˜å­˜åœ¨å…¶ä»–ä¸šåŠ¡å•Š æ¯”å¦‚å®¢æˆ·å–æ¬¾<br>è¿™ä¸ªæ—¶å€™ä¹Ÿæ˜¯å¯¹å…¨å±€å˜é‡balanceåšæ“ä½œ<br>å¦‚æœä¸åŠ é” å¹¶å‘æƒ…å†µä¸‹ä¼šå‡ºé—®é¢˜<br><br>è€å¸ˆä½ çœ‹æˆ‘è¯´çš„å¯¹å—ğŸ˜„ğŸ˜„ [4èµ]
        </div>
        <br/>
<div>
    <div style="color:#888;font-size:15.25px;font-weight:400;line-height:1.2">ä½œè€…å›å¤2019-03-14 12:23:23</div>
    <div style="color:#353535;font-weight:400;white-space:normal;word-break:break-all;line-height:1.6">ä½ è¯´åˆ°æˆ‘å¿ƒé‡Œäº†ğŸ˜ƒğŸ˜ƒğŸ˜ƒ<br></div>
</div>
            
    </div>
</li>
            
<br/>

<li>
    <div>
        <div style="color: #888;font-size:15.25px;font-weight:400;line-height:1.2">
            å‡ å­—å‡‰äº†ç§‹ä¸¶  2019-03-10 00:34:26
        </div>
        <div style="color:#353535;font-weight:400;white-space:normal;word-break:break-all;line-height:1.6">
            è€å¸ˆï¼Œè¯·é—®ä¸€ä¸‹ï¼Œåœ¨å®é™…çš„å¼€å‘ä¸­ï¼Œaccountå¯¹è±¡åº”è¯¥æ˜¯ä»æ•°æ®åº“ä¸­æŸ¥è¯¢å‡ºæ¥çš„å§ï¼Œå‡å¦‚Aè½¬Bï¼ŒCè½¬Bä¸€èµ·æ‰§è¡Œï¼Œé‚£Bçš„accountå¯¹è±¡å¦‚ä½•ä¿è¯æ˜¯åŒä¸€ä¸ªå¯¹è±¡ï¼Œä¸å¤ªç†è§£ã€‚ã€‚ã€‚ [4èµ]
        </div>
        <br/>
<div>
    <div style="color:#888;font-size:15.25px;font-weight:400;line-height:1.2">ä½œè€…å›å¤2019-03-10 11:48:44</div>
    <div style="color:#353535;font-weight:400;white-space:normal;word-break:break-all;line-height:1.6">å®é™…å¼€å‘ä¸­éƒ½æ˜¯ç”¨æ•°æ®åº“äº‹åŠ¡+ä¹è§‚é”çš„æ–¹å¼è§£å†³çš„ã€‚è¿™ä¸ªå°±æ˜¯ä¸ªä¾‹å­ï¼Œä¸ºäº†è¯´æ˜æ­»é”æ˜¯æ€ä¹ˆå›äº‹ï¼Œä»¥åŠæ­»é”é—®é¢˜æ€ä¹ˆè§£å†³ã€‚</div>
</div>
            
    </div>
</li>
            
<br/>

<li>
    <div>
        <div style="color: #888;font-size:15.25px;font-weight:400;line-height:1.2">
            è½»æ­Œèµ‹  2019-03-09 15:00:53
        </div>
        <div style="color:#353535;font-weight:400;white-space:normal;word-break:break-all;line-height:1.6">
            å­˜åœ¨æ€§èƒ½å·®è·ï¼Œè™½ç„¶ç”³è¯·çš„æ—¶å€™åŠ é”å¯¼è‡´å•çº¿ç¨‹è®¿é—®ï¼Œä½†æ˜¯hashåˆ¤æ–­å’Œèµ‹å€¼æ—¶é—´å¤æ‚åº¦ä½ï¼Œè€Œåœ¨é”ä¸­æ‰§è¡Œä¸šåŠ¡ä»£ç æ—¶é—´é•¿å¾ˆå¤šã€‚<br>ç”³è¯·çš„æ—¶å€™å•çº¿ç¨‹ï¼Œä½†æ˜¯æ‰§è¡Œçš„æ—¶å€™å°±å¯ä»¥å¤šçº¿ç¨‹äº†ï¼Œè¿™é‡Œæ€§èƒ½æå‡æ¯”è¾ƒæ˜æ˜¾<br><br>æƒ³é—®é—®è€å¸ˆï¼Œå¦‚ä½•åˆ¤æ–­å¤šçº¿ç¨‹çš„é˜»å¡å¯¼è‡´çš„é—®é¢˜å‘¢ï¼Ÿæœ‰ä»€ä¹ˆå·¥å…·å— [4èµ]
        </div>
        <br/>
<div>
    <div style="color:#888;font-size:15.25px;font-weight:400;line-height:1.2">ä½œè€…å›å¤2019-03-09 21:37:01</div>
    <div style="color:#353535;font-weight:400;white-space:normal;word-break:break-all;line-height:1.6">å¯ä»¥ç”¨topå‘½ä»¤æŸ¥çœ‹Javaçº¿ç¨‹çš„cpuåˆ©ç”¨ç‡ï¼Œç”¨jstackæ¥dumpçº¿ç¨‹ã€‚å¼€å‘ç¯å¢ƒå¯ä»¥ç”¨ java visualvmæŸ¥çœ‹çº¿ç¨‹æ‰§è¡Œæƒ…å†µ</div>
</div>
            
    </div>
</li>
            
<br/>

<li>
    <div>
        <div style="color: #888;font-size:15.25px;font-weight:400;line-height:1.2">
            winter  2019-03-09 12:58:50
        </div>
        <div style="color:#353535;font-weight:400;white-space:normal;word-break:break-all;line-height:1.6">
            æˆ‘çš„æƒ³æ³•æ˜¯ï¼Œå¦‚æœAccountå¯¹è±¡ä¸­åªæœ‰è½¬è´¦ä¸šåŠ¡çš„è¯ï¼Œwhile(actr.apply(this, target)å’Œå¯¹è±¡é”synchronized(Account.class)çš„æ€§èƒ½ä¼˜åŠ¿å‡ ä¹çœ‹ä¸å‡ºæ¥ï¼Œsynchronized(Account.class)çš„æ€§èƒ½ç”šè‡³æ›´å·®ï¼›ä½†æ˜¯å¦‚æœAccountå¯¹è±¡ä¸­å¦‚æœè¿˜æœ‰å…¶å®ƒä¸šåŠ¡ï¼Œæ¯”å¦‚æŸ¥çœ‹ä½™é¢ç­‰åŠŸèƒ½ä¹ŸåŠ äº†synchronized(Account.class)ä¿®é¥°ï¼Œé‚£ä¹ˆæŠŠå•ç‹¬çš„è½¬è´¦ä¸šåŠ¡å‰¥ç¦»å‡ºæ¥ï¼Œæ€§èƒ½çš„æå‡å¯èƒ½å°±æ¯”è¾ƒæ˜æ˜¾äº†ã€‚<br> [4èµ]
        </div>
        <br/>
<div>
    <div style="color:#888;font-size:15.25px;font-weight:400;line-height:1.2">ä½œè€…å›å¤2019-03-09 15:01:45</div>
    <div style="color:#353535;font-weight:400;white-space:normal;word-break:break-all;line-height:1.6">æ˜¯çš„ï¼Œæœ‰æ—¶å€™æ€§èƒ½æ›´å·®ï¼Œæ¯•ç«Ÿè¦synchronizedä¸‰æ¬¡ã€‚ä½†æ˜¯æœ‰äº›åœºæ™¯ä¼šæ›´å¥½ï¼Œä¾‹å¦‚è½¬è´¦æ“ä½œå¾ˆæ…¢ï¼Œè€Œapplyå¾ˆå¿«ï¼Œè¿™ä¸ªæ—¶å€™å…è®¸a-&gt;b,c-&gt;då¹¶è¡Œå°±æœ‰ä¼˜åŠ¿äº†ã€‚</div>
</div>
            
    </div>
</li>
            
<br/>

<li>
    <div>
        <div style="color: #888;font-size:15.25px;font-weight:400;line-height:1.2">
            å¼ ç«‹å  2019-03-12 19:54:32
        </div>
        <div style="color:#353535;font-weight:400;white-space:normal;word-break:break-all;line-height:1.6">
            ä¹‹å‰é‡åˆ°æ­»é”ï¼Œæˆ‘å°±æ˜¯ç”¨èµ„æºidçš„ä»å°åˆ°å¤§çš„é¡ºåºå»ç”³è¯·é”è§£å†³çš„ [3èµ]
        </div>
        <br/>
<div>
    <div style="color:#888;font-size:15.25px;font-weight:400;line-height:1.2">ä½œè€…å›å¤2019-03-12 20:28:38</div>
    <div style="color:#353535;font-weight:400;white-space:normal;word-break:break-all;line-height:1.6">è¿™ä¸ªæ–¹æ¡ˆæœ€ç®€å•<br></div>
</div>
            
    </div>
</li>
            
<br/>

<li>
    <div>
        <div style="color: #888;font-size:15.25px;font-weight:400;line-height:1.2">
            gogo  2019-03-10 11:55:22
        </div>
        <div style="color:#353535;font-weight:400;white-space:normal;word-break:break-all;line-height:1.6">
            çœ‹äº†è€å¸ˆçš„è®²è§£å­¦åˆ°äº†å¾ˆå¤šï¼Œè”æƒ³äº†ä¸‹å®é™…è½¬è´¦ä¸šåŠ¡ï¼Œåº”è¯¥æ˜¯æ•°æ®åº“æ¥å®ç°çš„ï¼Œå‡å¦‚æœ‰è´¦æˆ·è¡¨accountï¼Œåˆ©ç”¨mysqlçš„æ‚²è§‚é”select ...for updateå¯¹aï¼Œbä¸¤æ¡æ•°æ®é”å®šï¼Œè¿™æ—¶ä¹Ÿæœ‰å¯èƒ½å‘ç”Ÿæ­»é”ï¼ŒæŒ‰ç…§æ‚¨è®²åˆ°çš„ç¬¬ä¸‰ç§ç ´åå¾ªç¯ç­‰å¾…çš„æ–¹å¼ï¼ŒæŒ‰ç…§idçš„å¤§å°é¡ºåºä¾æ¬¡é”å®šã€‚æˆ‘è¿™æ ·ç†è§£çš„å¯¹å—ï¼Ÿ [3èµ]
        </div>
        <br/>
<div>
    <div style="color:#888;font-size:15.25px;font-weight:400;line-height:1.2">ä½œè€…å›å¤2019-03-10 14:49:24</div>
    <div style="color:#353535;font-weight:400;white-space:normal;word-break:break-all;line-height:1.6">æ˜¯çš„ï¼Œå°±æ˜¯idçš„æ¬¡åºã€‚</div>
</div>
            
    </div>
</li>
            
<br/>

<li>
    <div>
        <div style="color: #888;font-size:15.25px;font-weight:400;line-height:1.2">
            é™ˆå  2019-03-14 11:56:24
        </div>
        <div style="color:#353535;font-weight:400;white-space:normal;word-break:break-all;line-height:1.6">
            å¯¹äºç¬¬ä¸‰ç‚¹ï¼ŒæŒ‰èµ„æºé¡ºåºæ¥é”å°±èƒ½æ‰“ç ´å¾ªç¯ç­‰å¾…æœ‰ç–‘é—®ã€‚<br>ä¾‹å¦‚ï¼šè´¦æˆ· 1 å‘ è´¦æˆ· 3 è½¬è´¦<br>  åŒæ—¶ è´¦æˆ· 3 å‘ è´¦æˆ· 5 è½¬è´¦<br>å³ä½¿æŒ‰èµ„æºé¡ºåºæ¥é”ï¼Œä¹Ÿæ˜¯èµ·ä¸äº†å•¥ä½œç”¨å§ï¼ï¼Ÿï¼Œ [2èµ]
        </div>
        <br/>
<div>
    <div style="color:#888;font-size:15.25px;font-weight:400;line-height:1.2">ä½œè€…å›å¤2019-03-14 12:22:44</div>
    <div style="color:#353535;font-weight:400;white-space:normal;word-break:break-all;line-height:1.6">èƒ½èµ·ä½œç”¨ï¼Œè¿™ä¿©æ“ä½œä¸ä¼šæ­»é”<br></div>
</div>
            
    </div>
</li>
            
<br/>

<li>
    <div>
        <div style="color: #888;font-size:15.25px;font-weight:400;line-height:1.2">
            aguan(^ï½¥ï½ªï½¥^)  2019-03-14 09:44:11
        </div>
        <div style="color:#353535;font-weight:400;white-space:normal;word-break:break-all;line-height:1.6">
            è€å¸ˆï¼Œåœ¨ç ´åå ç”¨ä¸”ç­‰å¾…çš„æ¡ˆä¾‹ä¸­ï¼Œä¸ºä½•ç”³è¯·å®Œä¸¤ä¸ªè´¦æˆ·çš„èµ„æºåè¿˜éœ€è¦å†åˆ†åˆ«é”å®šthiså’Œtargetè´¦æˆ·å‘¢ï¼Ÿ [2èµ]
        </div>
        <br/>
<div>
    <div style="color:#888;font-size:15.25px;font-weight:400;line-height:1.2">ä½œè€…å›å¤2019-03-14 12:15:37</div>
    <div style="color:#353535;font-weight:400;white-space:normal;word-break:break-all;line-height:1.6">ä¸ºäº†ä¿é™©è€Œå·²ï¼Œå•çº¯è¿™ä¸ªä¾‹å­æ˜¯ä¸éœ€è¦çš„ï¼Œå¦‚æœè¿˜æœ‰å–æ¬¾æ“ä½œå°±éœ€è¦äº†<br></div>
</div>
            
    </div>
</li>
            
<br/>

<li>
    <div>
        <div style="color: #888;font-size:15.25px;font-weight:400;line-height:1.2">
            QQæ€ª  2019-03-09 22:11:05
        </div>
        <div style="color:#353535;font-weight:400;white-space:normal;word-break:break-all;line-height:1.6">
            æ­»å¾ªç¯åªæ˜¯é”çš„æ˜¯ä¸¤ä¸ªå¯¹è±¡ï¼Œè€ŒAccounté”çš„æ˜¯æ‰€æœ‰ï¼Œä¸²è¡ŒåŒ–äº† [2èµ]
        </div>
        <br/>
<div>
    <div style="color:#888;font-size:15.25px;font-weight:400;line-height:1.2">ä½œè€…å›å¤2019-03-09 22:57:10</div>
    <div style="color:#353535;font-weight:400;white-space:normal;word-break:break-all;line-height:1.6">æ­»å¾ªç¯é‡Œå…¶å®ä¹Ÿè¿˜é”äº†ä¸€ä¸ªå…¨å±€å¯¹è±¡</div>
</div>
            
    </div>
</li>
            
<br/>

<li>
    <div>
        <div style="color: #888;font-size:15.25px;font-weight:400;line-height:1.2">
            æ–°ä¸–ç•Œ  2019-03-09 07:20:58
        </div>
        <div style="color:#353535;font-weight:400;white-space:normal;word-break:break-all;line-height:1.6">
            æ²¡æœ‰æ€§èƒ½ä¼˜åŠ¿ï¼Œalloctorçš„æ“ä½œä¹Ÿæ˜¯è·å–alloctorå¯¹è±¡çš„é”ï¼Œå’Œè·å–accountçš„å¯¹è±¡é”æœ¬è´¨æ²¡æœ‰åŒºåˆ« [2èµ]
        </div>
        <br/>
<div>
    <div style="color:#888;font-size:15.25px;font-weight:400;line-height:1.2">ä½œè€…å›å¤2019-03-09 09:28:43</div>
    <div style="color:#353535;font-weight:400;white-space:normal;word-break:break-all;line-height:1.6">é”çš„èŒƒå›´å˜äº†ï¼Œæ‰€ä»¥åœºæ™¯ä¸åŒæ€§èƒ½ä¹Ÿä¼šæœ‰å·®å¼‚ï¼Œå¹¶å‘é‡å°çš„è¯ï¼Œæ€§èƒ½è¿˜ä¼šå˜å·®<br></div>
</div>
            
    </div>
</li>
            
<br/>

<li>
    <div>
        <div style="color: #888;font-size:15.25px;font-weight:400;line-height:1.2">
            è¥¿è¥¿å¼—ä¸å¡å¤«å¡  2019-03-09 00:53:48
        </div>
        <div style="color:#353535;font-weight:400;white-space:normal;word-break:break-all;line-height:1.6">
            æ€§èƒ½ä¼˜åŠ¿è¿˜æ˜¯æœ‰çš„ï¼Œæ¯•ç«Ÿåè€…æ˜¯å¯¹è¿™ä¸ªç±»çš„æ‰€æœ‰è®¿é—®éƒ½æœ‰é”çš„åŠ¨ä½œ [2èµ]
        </div>
        <br/>
<div>
    <div style="color:#888;font-size:15.25px;font-weight:400;line-height:1.2">ä½œè€…å›å¤2019-03-09 14:32:38</div>
    <div style="color:#353535;font-weight:400;white-space:normal;word-break:break-all;line-height:1.6">æ˜¯çš„ï¼Œé”çš„èŒƒå›´æ˜¯ä¸ªå¤§é—®é¢˜ã€‚å…è®¸A-&gt;B å’Œ C-&gt;Då¯ä»¥å¹¶è¡Œè¿˜æ˜¯å¾ˆé‡è¦çš„</div>
</div>
            
    </div>
</li>
            
<br/>

<li>
    <div>
        <div style="color: #888;font-size:15.25px;font-weight:400;line-height:1.2">
            æå¯å¨  2019-03-17 14:41:07
        </div>
        <div style="color:#353535;font-weight:400;white-space:normal;word-break:break-all;line-height:1.6">
            è€å¸ˆä¸ºä»€ä¹ˆæŒ‰åºç”³è¯·èµ„æºå°±å¯ä»¥ç ´åå¾ªç¯ç­‰å¾…æ¡ä»¶å‘¢ï¼Ÿè¿™ç‚¹æ²¡æœ‰çœ‹æ‡‚æ±‚è§£ç­” [1èµ]
        </div>
        <br/>
<div>
    <div style="color:#888;font-size:15.25px;font-weight:400;line-height:1.2">ä½œè€…å›å¤2019-03-17 17:15:02</div>
    <div style="color:#353535;font-weight:400;white-space:normal;word-break:break-all;line-height:1.6">å¾ªç¯ç­‰å¾…ï¼Œä¸€å®šæ˜¯A-&gt;B-&gt;C-&gt;...-&gt;N-&gt;Aå½¢æˆç¯çŠ¶ã€‚<br>å¦‚æœæŒ‰éœ€ç”³è¯·ï¼Œæ˜¯ä¸å…è®¸N-&gt;Aå‡ºç°çš„ï¼Œåªèƒ½N-&gt;Pã€‚æ²¡æœ‰ç¯çŠ¶ï¼Œä¹Ÿå°±ä¸ä¼šæ­»é”äº†ã€‚</div>
</div>
            
    </div>
</li>
            
<br/>

<li>
    <div>
        <div style="color: #888;font-size:15.25px;font-weight:400;line-height:1.2">
            å˜Ÿå˜Ÿç§‘æŠ€ç ”å‘éƒ¨  2019-03-15 08:23:11
        </div>
        <div style="color:#353535;font-weight:400;white-space:normal;word-break:break-all;line-height:1.6">
            class Allocator {<br>  private List&lt;Object&gt; als =<br>    new ArrayList&lt;&gt;();<br>  &#47;&#47; ä¸€æ¬¡æ€§ç”³è¯·æ‰€æœ‰èµ„æº<br>  synchronized boolean apply(<br>    Object from, Object to){<br>    if(als.contains(from) ||<br>         als.contains(to)){<br>      return false;  <br>    } else {<br>      als.add(from);<br>      als.add(to);  <br>    }<br>    return true;<br>  }<br>  &#47;&#47; å½’è¿˜èµ„æº<br>  synchronized void free(<br>    Object from, Object to){<br>    als.remove(from);<br>    als.remove(to);<br>  }<br>}<br><br>class Account {<br>  &#47;&#47; actr åº”è¯¥ä¸ºå•ä¾‹<br>  private Allocator actr;<br>  private int balance;<br>  &#47;&#47; è½¬è´¦<br>  void transfer(Account target, int amt){<br>    &#47;&#47; ä¸€æ¬¡æ€§ç”³è¯·è½¬å‡ºè´¦æˆ·å’Œè½¬å…¥è´¦æˆ·ï¼Œç›´åˆ°æˆåŠŸ<br>    while(!actr.apply(this, target))<br>      ï¼›<br>    try{<br>      &#47;&#47; é”å®šè½¬å‡ºè´¦æˆ·<br>      synchronized(this){              <br>        &#47;&#47; é”å®šè½¬å…¥è´¦æˆ·<br>        synchronized(target){           <br>          if (this.balance &gt; amt){<br>            this.balance -= amt;<br>            target.balance += amt;<br>          }<br>        }<br>      }<br>    } finally {<br>      actr.free(this, target)<br>    }<br>  } <br>}<br>è¿™æ®µä»£ç è¿˜æ˜¯ä¼šå‘ç”Ÿæ­»é”çš„ï¼›åœºæ™¯å¦‚ä¸‹ï¼šçº¿ç¨‹1 Aè½¬è´¦ç»™Bï¼Œçº¿ç¨‹2 Bè½¬è´¦ç»™Aï¼šçº¿ç¨‹1æ‰§è¡Œå®Œwhile(!actr.apply(this, target))ï¼›è¿™æ®µä»£ç ä¹‹åï¼Œé‡Šæ”¾2ä¸ªèµ„æºï¼Œç„¶åäº¤å‡ºCPU;æ­¤æ—¶çº¿ç¨‹2ä¹Ÿæ‰§è¡Œwhile(!actr.apply(this, target))ï¼›è¿™æ®µä»£ç ï¼Œæ¥ç€çº¿ç¨‹2 è·å¾—Bèµ„æºï¼Œäº¤å‡ºCPUï¼Œç­‰å¾…ï¼›æ­¤æ—¶çº¿ç¨‹1è·å¾—Aèµ„æºï¼Œè¿™æ ·ä¸‹å»ï¼Œä¸¤ä¸ªçº¿ç¨‹è¿˜æ˜¯ä¼šæ­»é”çš„ï¼› ---- while(!actr.apply(this, target))è¿™æ®µä»£ç å’Œä¹‹åçš„ä»£ç æ²¡æœ‰å…³è”åœ¨ä¸€èµ·ï¼Œæ˜¯ç‹¬ç«‹çš„ï¼Œä¸æ˜¯åŸå­æ€§çš„ï¼› [1èµ]
        </div>
        <br/>
<div>
    <div style="color:#888;font-size:15.25px;font-weight:400;line-height:1.2">ä½œè€…å›å¤2019-03-15 12:15:01</div>
    <div style="color:#353535;font-weight:400;white-space:normal;word-break:break-all;line-height:1.6">é‡Šæ”¾2ä¸ªèµ„æºæ˜¯åœ¨è½¬è´¦å®Œæˆä¹‹åï¼Œè€Œä¸æ˜¯whileæ‰§è¡Œå®Œã€‚çº¿ç¨‹2è·å¾—èµ„æºä¸€å®šæ˜¯çº¿ç¨‹1 æ‰§è¡Œå®Œè½¬è´¦äº†<br></div>
</div>
            
    </div>
</li>
            
<br/>

<li>
    <div>
        <div style="color: #888;font-size:15.25px;font-weight:400;line-height:1.2">
            GP  2019-03-13 19:35:48
        </div>
        <div style="color:#353535;font-weight:400;white-space:normal;word-break:break-all;line-height:1.6">
            é—®ä¸‹ï¼Œä¸ŠèŠ‚æœ€åè¯´åˆ°ï¼Œä¸èƒ½ç”¨å¯å˜å¯¹è±¡åšé”ï¼Œè¿™é‡Œä¸ºä½•åˆsynchronizedï¼ˆleftï¼‰ï¼Ÿ [1èµ]
        </div>
        <br/>
<div>
    <div style="color:#888;font-size:15.25px;font-weight:400;line-height:1.2">ä½œè€…å›å¤2019-03-13 21:24:18</div>
    <div style="color:#353535;font-weight:400;white-space:normal;word-break:break-all;line-height:1.6">ä¿æŠ¤çš„æ˜¯å¯¹è±¡é‡Œé¢çš„æˆå‘˜ï¼Œè¿™ä¿©å¯¹è±¡å˜ä¹Ÿåªèƒ½æ˜¯é‡Œé¢æˆå‘˜å˜ï¼Œç›¸å¯¹äºé‡Œé¢çš„æˆå‘˜æ¥è¯´ï¼Œè¿™ä¿©å¯¹è±¡æ˜¯æ°¸è¿œä¸ä¼šå˜çš„ã€‚ä½ å¯ä»¥è¿™æ ·ç†è§£ã€‚ä¸æ˜¯ç»å¯¹ä¸èƒ½ç”¨äºå¯å˜å¯¹è±¡ï¼Œåªæ˜¯ä¸€æ¡æœ€ä½³å®è·µã€‚</div>
</div>
            
    </div>
</li>
            
<br/>

<li>
    <div>
        <div style="color: #888;font-size:15.25px;font-weight:400;line-height:1.2">
            Î»  2019-03-11 19:29:09
        </div>
        <div style="color:#353535;font-weight:400;white-space:normal;word-break:break-all;line-height:1.6">
            å•ä¾‹å¯¼è‡´æ“ä½œä¹Ÿæ˜¯ä¸²è¡Œçš„å§ [1èµ]
        </div>
        <br/>
<div>
    <div style="color:#888;font-size:15.25px;font-weight:400;line-height:1.2">ä½œè€…å›å¤2019-03-11 21:18:29</div>
    <div style="color:#353535;font-weight:400;white-space:normal;word-break:break-all;line-height:1.6">æ˜¯ä¸²è¡Œï¼Œä½†æ˜¯å…è®¸Aè½¬Bï¼ŒCè½¬D</div>
</div>
            
    </div>
</li>
            </ul>
</div>
</body>
</html>